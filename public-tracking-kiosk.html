<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Track Your Vehicle - Kiosk Mode</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      overflow-x: hidden;
      -webkit-user-select: none;
      user-select: none;
      background: var(--bg);
    }
    
    /* Kiosk Welcome Screen */
    .kiosk-welcome {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
    }
    .welcome-card {
      max-width: 600px;
      background: var(--card);
      padding: 48px 32px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    .shop-logo-large {
      max-height: 100px;
      margin-bottom: 24px;
    }
    .welcome-title {
      font-size: 2rem;
      margin: 0 0 16px 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .welcome-subtitle {
      font-size: 1.125rem;
      color: var(--muted);
      margin-bottom: 32px;
    }
    
    /* Code Entry */
    .code-entry-container {
      margin-bottom: 24px;
    }
    .code-entry-label {
      font-size: 0.875rem;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
      display: block;
      font-weight: 600;
    }
    .code-input {
      width: 100%;
      max-width: 300px;
      font-size: 2rem;
      font-family: 'Courier New', monospace;
      text-align: center;
      padding: 16px;
      border: 3px solid var(--line);
      border-radius: 12px;
      text-transform: uppercase;
      letter-spacing: 4px;
      transition: all 0.2s;
      background: var(--bg);
      color: var(--text);
    }
    .code-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    .code-input.error {
      border-color: #ef4444;
      animation: shake 0.3s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    .track-btn {
      width: 100%;
      max-width: 300px;
      padding: 18px 36px;
      font-size: 1.125rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .track-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    .track-btn:active:not(:disabled) {
      transform: translateY(0);
    }
    .track-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .helper-text {
      margin-top: 24px;
      font-size: 0.875rem;
      color: var(--muted);
      line-height: 1.6;
    }
    .helper-text strong {
      color: var(--text);
    }
    
    .error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 12px;
      padding: 12px;
      background: #fee2e2;
      border-radius: 8px;
      display: none;
    }
    
    /* Tracking Display - Same as regular tracker */
    .tracking-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      display: none;
    }
    
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 12px 24px;
      background: var(--card);
      border: 2px solid var(--line);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      z-index: 1000;
    }
    .back-btn:hover {
      background: var(--bg);
      transform: translateX(-4px);
    }
    
    /* Same styles as public-tracking.html */
    .vehicle-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }
    .vehicle-card h2 {
      margin: 0 0 12px 0;
      font-size: 2rem;
    }
    .vehicle-card .code-display {
      font-family: 'Courier New', monospace;
      font-size: 1.25rem;
      opacity: 0.9;
      letter-spacing: 2px;
    }
    
    .status-section {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .status-badge {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 24px;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
    }
    .status-badge.new { background: #8b5cf6; color: white; }
    .status-badge.scheduled { background: #3b82f6; color: white; }
    .status-badge.in-progress { background: #f59e0b; color: white; }
    .status-badge.in_progress { background: #f59e0b; color: white; }
    .status-badge.awaiting-parts { background: #ec4899; color: white; }
    .status-badge.awaiting_parts { background: #ec4899; color: white; }
    .status-badge.completed { background: #10b981; color: white; }
    .status-badge.cancelled { background: #ef4444; color: white; }
    
    .status-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }
    .status-item {
      padding: 16px;
      background: var(--bg);
      border-radius: 12px;
    }
    .status-item label {
      display: block;
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .status-item .value {
      font-weight: 700;
      color: var(--text);
      font-size: 1.125rem;
    }
    
    .services-section {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .services-section h3 {
      margin: 0 0 24px 0;
      font-size: 1.5rem;
    }
    .service-item {
      display: flex;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--line);
      gap: 16px;
    }
    .service-item:last-child {
      border-bottom: none;
    }
    .service-icon {
      font-size: 2rem;
    }
    .service-name {
      flex: 1;
      font-weight: 600;
      font-size: 1.125rem;
    }
    
    /* Invoice Section */
    .invoice-section {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .invoice-section h3 {
      margin: 0 0 24px 0;
      font-size: 1.5rem;
    }
    .invoice-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--line);
    }
    .invoice-item:last-child {
      border-bottom: none;
    }
    .invoice-description {
      flex: 1;
    }
    .invoice-description label {
      display: block;
      font-size: 0.875rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .invoice-description .name {
      font-weight: 600;
      font-size: 1.125rem;
      color: var(--text);
    }
    .invoice-amount {
      font-weight: 700;
      font-size: 1.25rem;
      color: #10b981;
    }
    .invoice-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 2px solid var(--line);
      font-size: 1.25rem;
      font-weight: 700;
    }
    .invoice-total .total-amount {
      color: #667eea;
      font-size: 1.75rem;
    }
    
    /* Approved Services Tab */
    .approved-services-section {
      background: var(--card);
      padding: 32px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .approved-services-section h3 {
      margin: 0 0 24px 0;
      font-size: 1.5rem;
    }
    .approved-service-item {
      display: flex;
      align-items: center;
      padding: 16px;
      background: #f0fdf4;
      border-left: 4px solid #10b981;
      border-radius: 8px;
      margin-bottom: 12px;
      gap: 16px;
    }
    .approved-service-item:last-child {
      margin-bottom: 0;
    }
    .approved-service-icon {
      font-size: 1.5rem;
    }
    .approved-service-info {
      flex: 1;
    }
    .approved-service-info .name {
      font-weight: 600;
      color: var(--text);
    }
    .approved-service-info .status {
      font-size: 0.75rem;
      color: #10b981;
      text-transform: uppercase;
      font-weight: 600;
      margin-top: 2px;
    }
    
    /* Pending Estimates Section */
    .pending-estimates-section {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
      border: 2px solid #f59e0b;
    }
    .pending-estimates-section h3 {
      margin-bottom: 8px;
    }
    .pending-estimate-item {
      display: flex;
      align-items: center;
      padding: 20px;
      background: white;
      border-left: 4px solid #f59e0b;
      border-radius: 8px;
      margin-bottom: 12px;
      gap: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .pending-estimate-item:last-child {
      margin-bottom: 0;
    }
    .pending-estimate-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .pending-estimate-buttons .btn {
      padding: 12px 24px;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      border: none;
    }
    .pending-estimate-buttons .btn-approve {
      background: #10b981;
      color: white;
      box-shadow: 0 2px 4px rgba(16,185,129,0.3);
    }
    .pending-estimate-buttons .btn-decline {
      background: #ef4444;
      color: white;
      box-shadow: 0 2px 4px rgba(239,68,68,0.3);
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @media (max-width: 768px) {
      .welcome-title {
        font-size: 1.5rem;
      }
      .code-input {
        font-size: 1.5rem;
        letter-spacing: 2px;
      }
      .status-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Kiosk Welcome Screen -->
  <div id="welcomeScreen" class="kiosk-welcome">
    <div class="welcome-card">
      <img id="shopLogoWelcome" src="" alt="Shop Logo" class="shop-logo-large" style="display: none;">
      <h1 class="welcome-title">Track Your Vehicle</h1>
      <p class="welcome-subtitle">Enter your tracking code to view your vehicle's status</p>
      
      <div class="code-entry-container">
        <label class="code-entry-label">Tracking Code</label>
        <input 
          type="text" 
          id="codeInput" 
          class="code-input" 
          placeholder="XX-1234"
          maxlength="8"
          autocomplete="off"
          autofocus
        >
        <div id="errorMessage" class="error-message"></div>
      </div>
      
      <button id="trackBtn" class="track-btn">Track Vehicle</button>
      
      <div class="helper-text">
        <strong>Need help?</strong><br>
        Your tracking code was sent via SMS or email.<br>
        Ask our staff if you don't have your code.
      </div>
    </div>
  </div>

  <!-- Tracking Display -->
  <div id="trackingDisplay" class="tracking-container">
    <button id="backBtn" class="back-btn">
      ‚Üê Enter New Code
    </button>
    
    <!-- Notification Banner -->
    <div id="notificationBanner" style="display:none;background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:24px;box-shadow:0 4px 12px rgba(16,185,129,0.3);animation:slideDown 0.4s ease;">
      <div style="display:flex;align-items:center;gap:16px;">
        <span style="font-size:32px;">üîî</span>
        <div style="flex:1;">
          <div id="notificationTitle" style="font-weight:700;font-size:1.25rem;margin-bottom:6px;"></div>
          <div id="notificationMessage" style="opacity:0.95;font-size:1rem;"></div>
        </div>
      </div>
    </div>
    
    <div class="vehicle-card">
      <h2 id="vehicleInfo"></h2>
      <div class="code-display">Code: <span id="displayCode"></span></div>
    </div>
    
    <div class="status-section">
      <div>
        <span id="statusBadge" class="status-badge"></span>
      </div>
      <div class="status-details">
        <div class="status-item">
          <label>Technician</label>
          <div class="value" id="techName">-</div>
        </div>
        <div class="status-item">
          <label>Scheduled</label>
          <div class="value" id="scheduledDate">-</div>
        </div>
        <div class="status-item">
          <label>Est. Completion</label>
          <div class="value" id="estimatedCompletion">-</div>
        </div>
      </div>
    </div>
    
    <div class="services-section">
      <h3>Services</h3>
      <div id="servicesList"></div>
    </div>
    
    <div class="misc-section" id="miscSection" style="display: none;">
      <h3>Misc Parts & Labor</h3>
      <div style="background:#f8fafc;border-radius:8px;padding:16px;display:flex;justify-content:space-between;align-items:center;">
        <span style="color:#64748b;">Parts, materials, and labor charges</span>
        <span id="miscTotal" style="font-size:1.25rem;font-weight:700;color:#1f2937;">$0.00</span>
      </div>
    </div>
    
    <div class="invoice-section" id="invoiceSection" style="display: none;">
      <h3>Invoice</h3>
      <div id="invoiceList"></div>
      <div class="invoice-total">
        <span>Total:</span>
        <span class="total-amount" id="invoiceTotal">$0.00</span>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:24px;border-radius:12px;max-width:400px;margin:20px;text-align:center;">
      <h3 style="margin:0 0 16px 0;color:#1f2937;">Decline Service?</h3>
      <p id="confirmMessage" style="color:#6b7280;margin:0 0 24px 0;">Are you sure you want to decline this service? It will be removed from your invoice.</p>
      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="confirmCancel" style="flex:1;padding:12px 24px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        <button id="confirmYes" style="flex:1;padding:12px 24px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Yes, Decline</button>
      </div>
    </div>
  </div>

  <script src="vendor/supabase.umd.js"></script>
  <script src="helpers/tracking-code-generator.js"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://hxwufjzyhtwveyxbkkya.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4d3Vmanp5aHR3dmV5eGJra3lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjU0MjAsImV4cCI6MjA3ODMwMTQyMH0.nN7MGoYyqwhonOSPBJlFEZoZrOEAIRP79l43FZK5nh8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Polling for real-time updates
    let pollingInterval = null;
    let currentTrackingCode = null;

    // DOM Elements
    const welcomeScreen = document.getElementById('welcomeScreen');
    const trackingDisplay = document.getElementById('trackingDisplay');
    const codeInput = document.getElementById('codeInput');
    const trackBtn = document.getElementById('trackBtn');
    const backBtn = document.getElementById('backBtn');
    const errorMessage = document.getElementById('errorMessage');

    // Auto-format code as user types
    codeInput.addEventListener('input', (e) => {
      let value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
      
      // If user hasn't typed hyphen, auto-insert after letters
      if (!value.includes('-')) {
        // Try to auto-format: detect where letters end and numbers begin
        const match = value.match(/^([A-Z]{2,3})(\d{0,4})$/);
        if (match) {
          value = match[1] + (match[2] ? '-' + match[2] : '');
        }
      } else {
        // Clean up: ensure format is letters-numbers
        const parts = value.split('-');
        if (parts.length >= 2) {
          const letters = parts[0].replace(/[^A-Z]/g, '').substring(0, 3);
          const numbers = parts.slice(1).join('').replace(/[^0-9]/g, '').substring(0, 4);
          value = letters + (numbers ? '-' + numbers : '-');
        }
      }
      
      e.target.value = value.substring(0, 8); // Max 8 chars: ABC-1234
      errorMessage.style.display = 'none';
      codeInput.classList.remove('error');
    });

    // Track on Enter key
    codeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        trackBtn.click();
      }
    });

    // Track button click
    trackBtn.addEventListener('click', async () => {
      const code = codeInput.value.trim().toUpperCase();
      
      if (!code) {
        showError('Please enter a tracking code');
        return;
      }
      
      if (!window.trackingCodeGenerator.validateTrackingCode(code)) {
        showError('Invalid code format. Use format: XX-1234 or ABC-1234');
        return;
      }
      
      trackBtn.disabled = true;
      trackBtn.textContent = 'Loading...';
      
      try {
        await loadTracking(code, false); // false = not a silent refresh
      } catch (err) {
        showError('Unable to load tracking data. Please try again.');
        console.error(err);
      } finally {
        trackBtn.disabled = false;
        trackBtn.textContent = 'Track Vehicle';
      }
    });

    // Back button
    backBtn.addEventListener('click', () => {
      // Stop polling when going back
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('‚ùå Auto-refresh stopped');
      }
      currentTrackingCode = null;
      
      trackingDisplay.style.display = 'none';
      welcomeScreen.style.display = 'flex';
      codeInput.value = '';
      codeInput.focus();
    });

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      codeInput.classList.add('error');
      setTimeout(() => {
        codeInput.classList.remove('error');
      }, 300);
    }

    // Start polling for updates every 10 seconds
    function startPolling() {
      // Clear any existing interval
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      // Poll every 10 seconds
      pollingInterval = setInterval(() => {
        if (currentTrackingCode) {
          console.log('üîÑ Auto-refreshing tracking data...');
          loadTracking(currentTrackingCode, true); // Silent refresh (no error messages)
        }
      }, 10000); // 10 seconds
      
      console.log('‚úÖ Auto-refresh started (every 10 seconds)');
    }

    async function loadTracking(code, silentRefresh = false) {
      try {
        // Look up token by code
        const { data: tokenData, error: tokenError } = await supabase
          .from('appointment_tokens')
          .select('*')
          .eq('short_code', code)
          .gte('expires_at', new Date().toISOString())
          .single();

        if (tokenError || !tokenData) {
          console.error('Token lookup error:', tokenError);
          showError('Code not found or expired. Please check your code.');
          return;
        }

        const { appointment_id, shop_id } = tokenData;
        
        // Store shop_id globally for estimate approval/decline functions
        window.currentShopId = shop_id;

        // Fetch appointment data
        const { data: shopData, error: dataError } = await supabase
          .from('data')
          .select('appointments, invoices')
          .eq('shop_id', shop_id)
          .single();

        if (dataError || !shopData) {
          showError('Unable to load appointment data');
          return;
        }

        const appointment = (shopData.appointments || []).find(apt => apt.id === appointment_id);

        if (!appointment) {
          showError('Appointment not found');
          return;
        }

        // Find related invoice
        const invoice = (shopData.invoices || []).find(inv => inv.appointment_id === appointment_id);

        // Render tracking
        renderTracking(appointment, code, invoice);

        // Store current code for polling
        currentTrackingCode = code;

        // Switch screens (only on initial load, not refresh)
        if (!silentRefresh) {
          welcomeScreen.style.display = 'none';
          trackingDisplay.style.display = 'block';
          
          // Start polling for updates
          startPolling();
        }

      } catch (err) {
        console.error('Error loading tracking:', err);
        if (!silentRefresh) {
          showError('System error. Please try again.');
        }
      }
    }

    function renderTracking(appointment, code, invoice) {
      // Vehicle info
      const vehicleDisplay = appointment.vehicle || 'Vehicle';
      document.getElementById('vehicleInfo').textContent = vehicleDisplay;
      document.getElementById('displayCode').textContent = code;

      // Status
      const status = (appointment.status || 'scheduled').toLowerCase();
      const statusBadge = document.getElementById('statusBadge');
      statusBadge.textContent = status.replace('-', ' ').replace('_', ' ');
      statusBadge.className = 'status-badge ' + status;

      // Status details
      document.getElementById('techName').textContent = appointment.tech_name || 'Not assigned';
      document.getElementById('scheduledDate').textContent = appointment.preferred_date 
        ? new Date(appointment.preferred_date).toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short',
            day: 'numeric'
          })
        : '-';
      document.getElementById('estimatedCompletion').textContent = appointment.estimated_completion || 'TBD';

      // === SERVICES SECTION - All services go here ===
      const servicesList = document.getElementById('servicesList');
      const service = appointment.service || 'Service';
      
      let servicesHtml = '';
      
      // Check invoice for pending/approved estimates
      let pendingEstimates = [];
      let approvedItems = [];
      
      if (invoice && invoice.items) {
        pendingEstimates = invoice.items.filter(item => {
          const itemType = (item.type || '').toLowerCase();
          if (itemType === 'part' || itemType === 'labor') return false;
          // PENDING = has 'pending' status OR has NO estimate_status (new items need approval)
          return item.estimate_status === 'pending' || !item.estimate_status;
        });
        
        approvedItems = invoice.items.filter(item => {
          const itemType = (item.type || '').toLowerCase();
          if (itemType === 'part' || itemType === 'labor') return false;
          // APPROVED = only items explicitly marked as approved
          return item.estimate_status === 'approved';
        });
        
        console.log('üìä Invoice Items:', invoice.items);
        console.log('‚è≥ Pending estimates:', pendingEstimates);
        console.log('‚úÖ Approved items:', approvedItems);
      }
      
      // Show notification banner for pending estimates
      if (pendingEstimates.length > 0) {
        document.getElementById('notificationBanner').style.display = 'block';
        document.getElementById('notificationTitle').textContent = `üîî New Estimate! (${pendingEstimates.length} item${pendingEstimates.length > 1 ? 's' : ''})`;
        document.getElementById('notificationMessage').textContent = 'Please accept or decline below.';
      } else {
        document.getElementById('notificationBanner').style.display = 'none';
      }
      
      // 1. PENDING ESTIMATES FIRST - yellow with Accept/Decline buttons AT THE TOP
      pendingEstimates.forEach((item) => {
        const qty = parseFloat(item.qty || 1) || 1;
        const price = parseFloat(item.price || item.unit_price || 0) || 0;
        const itemTotal = qty * price;
        const itemIdx = invoice.items.indexOf(item);
        
        servicesHtml += `
          <div class="service-item" style="background:#fef3c7;border-left:4px solid #f59e0b;padding:16px;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;flex-wrap:wrap;">
            <span class="service-icon" style="color:#f59e0b;font-size:1.5rem;">‚è≥</span>
            <div style="flex:1;min-width:200px;">
              <div style="font-weight:600;font-size:1.1rem;">${item.name || '-'}</div>
              <div style="font-size:0.875rem;color:#78716c;">${qty > 1 ? qty + ' x ' : ''}$${price.toFixed(2)} = <strong>$${itemTotal.toFixed(2)}</strong></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;width:100%;">
              <button onclick="approveEstimate('${invoice.id}', ${itemIdx})" style="flex:1;background:#10b981;color:white;padding:12px 24px;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">‚úì Accept</button>
              <button onclick="declineEstimate('${invoice.id}', ${itemIdx})" style="flex:1;background:#ef4444;color:white;padding:12px 24px;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">‚úó Decline</button>
            </div>
          </div>
        `;
      });
      
      // 2. Original appointment service - always approved (green)
      let mainIcon = '‚úì';
      let mainStatus = 'Approved';
      let mainColor = '#10b981';
      
      if (status === 'completed') {
        mainStatus = 'Complete';
      } else if (status === 'in-progress' || status === 'in_progress') {
        mainIcon = 'üîß';
        mainStatus = 'In Progress';
        mainColor = '#3b82f6';
      }
      
      servicesHtml += `
        <div class="service-item" style="background:#f0fdf4;border-left:4px solid #10b981;padding:12px;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;">
          <span class="service-icon">${mainIcon}</span>
          <span class="service-name" style="flex:1;font-weight:600;">${service}</span>
          <span style="color:${mainColor};font-weight:600;">${mainStatus}</span>
        </div>
      `;
      
      // 3. Other approved estimate items - green
      approvedItems.forEach(item => {
        const qty = parseFloat(item.qty || 1) || 1;
        const price = parseFloat(item.price || item.unit_price || 0) || 0;
        const itemTotal = qty * price;
        
        servicesHtml += `
          <div class="service-item" style="background:#f0fdf4;border-left:4px solid #10b981;padding:12px;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;">
            <span class="service-icon">‚úì</span>
            <div style="flex:1;">
              <div style="font-weight:600;">${item.name || '-'}</div>
              <div style="font-size:0.875rem;color:#78716c;">${qty > 1 ? qty + ' x ' : ''}$${price.toFixed(2)} = $${itemTotal.toFixed(2)}</div>
            </div>
            <span style="color:#10b981;font-weight:600;">Approved</span>
          </div>
        `;
      });
      
      servicesList.innerHTML = servicesHtml;
      
      // Render Misc Parts & Labor section (parts, inventory, labor - just a total)
      const miscSection = document.getElementById('miscSection');
      const miscTotal = document.getElementById('miscTotal');
      
      if (invoice && invoice.items) {
        const miscItems = invoice.items.filter(item => {
          const itemType = (item.type || '').toLowerCase();
          return itemType === 'part' || itemType === 'labor' || itemType === 'inventory';
        });
        
        if (miscItems.length > 0) {
          let miscSum = 0;
          miscItems.forEach(item => {
            const qty = parseFloat(item.qty || 1) || 1;
            const price = parseFloat(item.price || item.unit_price || 0) || 0;
            miscSum += qty * price;
          });
          
          miscTotal.textContent = '$' + miscSum.toFixed(2);
          miscSection.style.display = 'block';
          console.log('üîß Misc items:', miscItems.length, 'Total:', miscSum);
        } else {
          miscSection.style.display = 'none';
        }
      } else {
        miscSection.style.display = 'none';
      }
      
      // Render Invoice (Services and Inventory only - NO Parts)
      // Only show APPROVED items in the invoice (exclude pending estimates)
      const invoiceSection = document.getElementById('invoiceSection');
      const invoiceList = document.getElementById('invoiceList');
      const invoiceTotal = document.getElementById('invoiceTotal');
      
      console.log('üßæ Full invoice object:', invoice);
      console.log('üßæ Invoice items with estimate_status:', invoice?.items?.map(i => ({name: i.name, type: i.type, estimate_status: i.estimate_status})));
      
      if (invoice && invoice.items && invoice.items.length > 0) {
        // Filter: services/inventory that are approved OR don't have estimate_status (legacy items)
        // Exclude: parts, labor, and PENDING estimates
        const filteredItems = (invoice.items || []).filter(item => {
          const itemType = (item.type || '').toLowerCase();
          // Exclude parts and labor
          if (itemType === 'part' || itemType === 'labor') return false;
          // Exclude pending estimates - they show in the approval section above
          if (item.estimate_status === 'pending') return false;
          // Include approved items AND items without estimate_status (legacy/normal items)
          return true;
        });
        
        console.log('üßæ Filtered items for invoice section:', filteredItems);
        
        if (filteredItems.length > 0) {
          let invoiceHtml = '';
          let subtotal = 0;
          
          filteredItems.forEach(item => {
            const qty = parseFloat(item.qty || 1) || 1;
            const price = parseFloat(item.price || item.unit_price || 0) || 0;
            const itemTotal = qty * price;
            subtotal += itemTotal;
            
            const itemType = (item.type || '').toLowerCase() === 'service' ? 'Service' : 'Item';
            invoiceHtml += `
              <div class="invoice-item">
                <div class="invoice-description">
                  <label>${itemType}</label>
                  <div class="name">${item.name || '-'}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.875rem; color: var(--muted); margin-bottom: 4px;">
                    ${qty > 1 ? qty + ' x ' : ''}$${price.toFixed(2)}
                  </div>
                  <div class="invoice-amount">$${itemTotal.toFixed(2)}</div>
                </div>
              </div>
            `;
          });
          
          invoiceList.innerHTML = invoiceHtml;
          
          // Calculate totals with tax/discount
          let tax = 0;
          let discount = 0;
          
          // Add misc parts & labor to subtotal
          const miscItems = (invoice.items || []).filter(item => {
            const itemType = (item.type || '').toLowerCase();
            return itemType === 'part' || itemType === 'labor' || itemType === 'inventory';
          });
          let miscSum = 0;
          miscItems.forEach(item => {
            const qty = parseFloat(item.qty || 1) || 1;
            const price = parseFloat(item.price || item.unit_price || 0) || 0;
            miscSum += qty * price;
          });
          
          const grandSubtotal = subtotal + miscSum;
          
          if (invoice.tax_rate) {
            tax = grandSubtotal * (parseFloat(invoice.tax_rate) / 100);
          }
          if (invoice.discount) {
            discount = parseFloat(invoice.discount) || 0;
          }
          
          const total = grandSubtotal + tax - discount;
          invoiceTotal.textContent = '$' + total.toFixed(2);
          invoiceSection.style.display = 'block';
        } else {
          // Even if no services, check if there are misc items to show
          const miscItems = (invoice.items || []).filter(item => {
            const itemType = (item.type || '').toLowerCase();
            return itemType === 'part' || itemType === 'labor' || itemType === 'inventory';
          });
          
          if (miscItems.length > 0) {
            let miscSum = 0;
            miscItems.forEach(item => {
              const qty = parseFloat(item.qty || 1) || 1;
              const price = parseFloat(item.price || item.unit_price || 0) || 0;
              miscSum += qty * price;
            });
            
            let tax = 0;
            let discount = 0;
            if (invoice.tax_rate) {
              tax = miscSum * (parseFloat(invoice.tax_rate) / 100);
            }
            if (invoice.discount) {
              discount = parseFloat(invoice.discount) || 0;
            }
            
            const total = miscSum + tax - discount;
            invoiceList.innerHTML = '';
            invoiceTotal.textContent = '$' + total.toFixed(2);
            invoiceSection.style.display = 'block';
          } else {
            invoiceSection.style.display = 'none';
          }
        }
      } else {
        invoiceSection.style.display = 'none';
      }
    }
    
    // Global functions for estimate approval/decline
    window.approveEstimate = async function(invoiceId, itemIdx) {
      const btn = event.target;
      try {
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        // Fetch current invoice data
        const { data: shopData, error: fetchError } = await supabase
          .from('data')
          .select('invoices')
          .eq('shop_id', window.currentShopId)
          .single();
        
        if (fetchError || !shopData) {
          throw new Error('Failed to load invoice data');
        }
        
        const invoices = shopData.invoices || [];
        const invoice = invoices.find(inv => inv.id === invoiceId);
        
        if (!invoice || !invoice.items || !invoice.items[itemIdx]) {
          throw new Error('Invoice or item not found');
        }
        
        // Update item status to approved
        invoice.items[itemIdx].estimate_status = 'approved';
        invoice.items[itemIdx].estimate_approved_at = new Date().toISOString();
        
        // Save back to database
        const { error: updateError } = await supabase
          .from('data')
          .update({ 
            invoices: invoices,
            updated_at: new Date().toISOString()
          })
          .eq('shop_id', window.currentShopId);
        
        if (updateError) throw updateError;
        
        console.log('‚úÖ Item approved successfully');
        
        // Re-fetch and re-render without full page reload
        if (currentTrackingCode) {
          await loadTracking(currentTrackingCode, true);
        }
      } catch (error) {
        console.error('Error approving estimate:', error);
        alert('Failed to approve estimate. Please try again.');
        if (btn) {
          btn.disabled = false;
          btn.textContent = '‚úì Accept';
        }
      }
    };
    
    // Pending decline data for modal
    let pendingDecline = null;
    
    window.declineEstimate = function(invoiceId, itemIdx) {
      // Store pending decline info
      pendingDecline = { invoiceId, itemIdx };
      
      // Show confirmation modal
      const modal = document.getElementById('confirmModal');
      modal.style.display = 'flex';
    };
    
    // Confirmation modal handlers
    document.getElementById('confirmCancel').addEventListener('click', function() {
      pendingDecline = null;
      document.getElementById('confirmModal').style.display = 'none';
    });
    
    document.getElementById('confirmYes').addEventListener('click', async function() {
      if (!pendingDecline) return;
      
      const { invoiceId, itemIdx } = pendingDecline;
      const btn = this;
      
      try {
        btn.disabled = true;
        btn.textContent = 'Removing...';
        
        // Fetch current invoice data
        const { data: shopData, error: fetchError } = await supabase
          .from('data')
          .select('invoices')
          .eq('shop_id', window.currentShopId)
          .single();
        
        if (fetchError || !shopData) {
          throw new Error('Failed to load invoice data');
        }
        
        const invoices = shopData.invoices || [];
        const invoice = invoices.find(inv => inv.id === invoiceId);
        
        if (!invoice || !invoice.items) {
          throw new Error('Invoice not found');
        }
        
        // Remove the item completely from invoice
        invoice.items.splice(itemIdx, 1);
        
        // Save back to database
        const { error: updateError } = await supabase
          .from('data')
          .update({ 
            invoices: invoices,
            updated_at: new Date().toISOString()
          })
          .eq('shop_id', window.currentShopId);
        
        if (updateError) throw updateError;
        
        console.log('‚ùå Item declined and removed');
        
        // Hide modal
        document.getElementById('confirmModal').style.display = 'none';
        pendingDecline = null;
        btn.disabled = false;
        btn.textContent = 'Yes, Decline';
        
        // Re-fetch and re-render without full page reload
        if (currentTrackingCode) {
          await loadTracking(currentTrackingCode, true);
        }
      } catch (error) {
        console.error('Error declining estimate:', error);
        alert('Failed to decline estimate. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Yes, Decline';
      }
    });
  </script>
</body>
</html>
