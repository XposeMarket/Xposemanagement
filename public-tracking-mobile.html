<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Track Your Vehicle</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      overflow-x: hidden;
      background: var(--bg);
    }
    
    /* Loading State */
    .loading-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
    }
    .loading-card {
      max-width: 400px;
      background: var(--card);
      padding: 48px 32px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--line);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error State */
    .error-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
    }
    .error-card {
      max-width: 400px;
      background: var(--card);
      padding: 48px 32px;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    .error-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    .error-title {
      font-size: 1.5rem;
      color: #ef4444;
      margin: 0 0 16px 0;
    }
    .error-message {
      color: var(--muted);
      margin-bottom: 24px;
    }
    
    /* Tracking Display */
    .tracking-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Same styles as public-tracking-kiosk.html */
    .vehicle-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px;
      border-radius: 16px;
      margin-bottom: 24px;
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }
    .vehicle-card h2 {
      margin: 0 0 12px 0;
      font-size: 1.75rem;
    }
    .vehicle-card .code-display {
      font-family: 'Courier New', monospace;
      font-size: 1.125rem;
      opacity: 0.9;
      letter-spacing: 2px;
    }
    
    .status-section {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .status-badge {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 24px;
      font-weight: 700;
      font-size: 1rem;
      text-transform: uppercase;
      margin-bottom: 24px;
      letter-spacing: 0.5px;
    }
    .status-badge.new { background: #8b5cf6; color: white; }
    .status-badge.scheduled { background: #3b82f6; color: white; }
    .status-badge.in-progress { background: #f59e0b; color: white; }
    .status-badge.in_progress { background: #f59e0b; color: white; }
    .status-badge.awaiting-parts { background: #ec4899; color: white; }
    .status-badge.awaiting_parts { background: #ec4899; color: white; }
    .status-badge.completed { background: #10b981; color: white; }
    .status-badge.cancelled { background: #ef4444; color: white; }
    
    .status-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-top: 24px;
    }
    .status-item {
      padding: 16px;
      background: var(--bg);
      border-radius: 12px;
    }
    .status-item label {
      display: block;
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 8px;
      font-weight: 600;
    }
    .status-item .value {
      font-weight: 700;
      color: var(--text);
      font-size: 1rem;
    }
    
    .services-section {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .services-section h3 {
      margin: 0 0 20px 0;
      font-size: 1.25rem;
    }
    .service-item {
      display: flex;
      align-items: center;
      padding: 14px;
      border-bottom: 1px solid var(--line);
      gap: 14px;
    }
    .service-item:last-child {
      border-bottom: none;
    }
    .service-icon {
      font-size: 1.5rem;
    }
    .service-name {
      flex: 1;
      font-weight: 600;
      font-size: 1rem;
    }
    
    /* Invoice Section */
    .invoice-section {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .invoice-section h3 {
      margin: 0 0 20px 0;
      font-size: 1.25rem;
    }
    .invoice-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--line);
    }
    .invoice-item:last-child {
      border-bottom: none;
    }
    .invoice-description {
      flex: 1;
    }
    .invoice-description label {
      display: block;
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .invoice-description .name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text);
    }
    .invoice-amount {
      font-weight: 700;
      font-size: 1.125rem;
      color: #10b981;
    }
    .invoice-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid var(--line);
      font-size: 1.125rem;
      font-weight: 700;
    }
    .invoice-total .total-amount {
      color: #667eea;
      font-size: 1.5rem;
    }
    
    /* Misc Parts & Labor */
    .misc-section {
      background: var(--card);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--line);
      margin-bottom: 24px;
    }
    .misc-section h3 {
      margin: 0 0 16px 0;
      font-size: 1.25rem;
    }
    
    /* Pending Estimates */
    .pending-estimate-item {
      display: flex;
      flex-direction: column;
      padding: 16px;
      background: white;
      border-left: 4px solid #f59e0b;
      border-radius: 8px;
      margin-bottom: 12px;
      gap: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .pending-estimate-item:last-child {
      margin-bottom: 0;
    }
    .pending-estimate-buttons {
      display: flex;
      gap: 10px;
    }
    .pending-estimate-buttons .btn {
      flex: 1;
      padding: 12px 20px;
      font-weight: 600;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      border: none;
    }
    .pending-estimate-buttons .btn-approve {
      background: #10b981;
      color: white;
      box-shadow: 0 2px 4px rgba(16,185,129,0.3);
    }
    .pending-estimate-buttons .btn-decline {
      background: #ef4444;
      color: white;
      box-shadow: 0 2px 4px rgba(239,68,68,0.3);
    }
    
    /* Notification Banner */
    .notification-banner {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(16,185,129,0.3);
      animation: slideDown 0.4s ease;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Footer */
    .powered-by {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: var(--muted);
      font-size: 0.875rem;
    }
    .powered-by img {
      height: 24px;
      vertical-align: middle;
      margin-left: 8px;
    }
    
    /* Responsive */
    @media (max-width: 480px) {
      .vehicle-card {
        padding: 24px;
      }
      .vehicle-card h2 {
        font-size: 1.5rem;
      }
      .status-details {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Loading State -->
  <div id="loadingState" class="loading-container">
    <div class="loading-card">
      <div class="spinner"></div>
      <p>Loading your vehicle status...</p>
    </div>
  </div>

  <!-- Error State -->
  <div id="errorState" class="error-container" style="display: none;">
    <div class="error-card">
      <div class="error-icon">‚ö†Ô∏è</div>
      <h2 class="error-title">Link Not Found</h2>
      <p id="errorMessage" class="error-message">This tracking link is invalid or has expired.</p>
      <p style="color: var(--muted); font-size: 0.875rem;">If you need assistance, please contact the shop directly.</p>
    </div>
  </div>

  <!-- Tracking Display -->
  <div id="trackingDisplay" class="tracking-container" style="display: none;">
    <!-- Notification Banner -->
    <div id="notificationBanner" class="notification-banner" style="display:none;">
      <div style="display:flex;align-items:center;gap:16px;">
        <span style="font-size:32px;">üîî</span>
        <div style="flex:1;">
          <div id="notificationTitle" style="font-weight:700;font-size:1.25rem;margin-bottom:6px;"></div>
          <div id="notificationMessage" style="opacity:0.95;font-size:1rem;"></div>
        </div>
      </div>
    </div>
    
    <div class="vehicle-card">
      <h2 id="vehicleInfo"></h2>
      <div class="code-display">Code: <span id="displayCode"></span></div>
    </div>
    
    <div class="status-section">
      <div>
        <span id="statusBadge" class="status-badge"></span>
      </div>
      <div class="status-details">
        <div class="status-item">
          <label>Technician</label>
          <div class="value" id="techName">-</div>
        </div>
        <div class="status-item">
          <label>Scheduled</label>
          <div class="value" id="scheduledDate">-</div>
        </div>
        <div class="status-item">
          <label>Est. Completion</label>
          <div class="value" id="estimatedCompletion">-</div>
        </div>
      </div>
    </div>
    
    <div class="services-section">
      <h3>Services</h3>
      <div id="servicesList"></div>
    </div>
    
    <div class="misc-section" id="miscSection" style="display: none;">
      <h3>Misc Parts & Labor</h3>
      <div style="background:#f8fafc;border-radius:8px;padding:16px;display:flex;justify-content:space-between;align-items:center;">
        <span style="color:#64748b;">Parts, materials, and labor charges</span>
        <span id="miscTotal" style="font-size:1.25rem;font-weight:700;color:#1f2937;">$0.00</span>
      </div>
    </div>
    
    <div class="invoice-section" id="invoiceSection" style="display: none;">
      <h3>Invoice</h3>
      <div id="invoiceList"></div>
      <div class="invoice-total">
        <span>Total:</span>
        <span class="total-amount" id="invoiceTotal">$0.00</span>
      </div>
      <button id="approveAllBtn" style="display:none;margin-top:18px;width:100%;background:#10b981;color:white;padding:14px 0;font-size:1.1rem;font-weight:700;border:none;border-radius:8px;cursor:pointer;box-shadow:0 2px 8px rgba(16,185,129,0.15);">‚úÖ Approve All & Open Invoice</button>
    </div>
    
    <div class="powered-by">
      Powered by <a href="https://xposemanagement.com" target="_blank">Xpose Management</a>
      <img src="assets/XposeManagementCRMlogo.png" alt="Xpose Management">
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:white;padding:24px;border-radius:12px;max-width:400px;margin:20px;text-align:center;">
      <h3 style="margin:0 0 16px 0;color:#1f2937;">Decline Service?</h3>
      <p id="confirmMessage" style="color:#6b7280;margin:0 0 24px 0;">Are you sure you want to decline this service? It will be removed from your invoice.</p>
      <div style="display:flex;gap:12px;justify-content:center;">
        <button id="confirmCancel" style="flex:1;padding:12px 24px;background:#e5e7eb;color:#374151;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Cancel</button>
        <button id="confirmYes" style="flex:1;padding:12px 24px;background:#ef4444;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;">Yes, Decline</button>
      </div>
    </div>
  </div>

  <script src="vendor/supabase.umd.js"></script>
  <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://hxwufjzyhtwveyxbkkya.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4d3Vmanp5aHR3dmV5eGJra3lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjU0MjAsImV4cCI6MjA3ODMwMTQyMH0.nN7MGoYyqwhonOSPBJlFEZoZrOEAIRP79l43FZK5nh8';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Polling for real-time updates
    let pollingInterval = null;
    let currentToken = null;

    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const errorState = document.getElementById('errorState');
    const trackingDisplay = document.getElementById('trackingDisplay');
    const errorMessage = document.getElementById('errorMessage');

    function showError(message) {
      loadingState.style.display = 'none';
      trackingDisplay.style.display = 'none';
      errorMessage.textContent = message;
      errorState.style.display = 'flex';
    }

    // Start polling for updates every 10 seconds
    function startPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      pollingInterval = setInterval(() => {
        if (currentToken) {
          console.log('üîÑ Auto-refreshing tracking data...');
          loadTracking(currentToken, true);
        }
      }, 10000);
      
      console.log('‚úÖ Auto-refresh started (every 10 seconds)');
    }

    async function loadTracking(token, silentRefresh = false) {
      try {
        // Check if this is a development token
        if (token.startsWith('dev_')) {
          console.warn('[Mobile Tracker] Development token detected - cannot look up in database');
          if (!silentRefresh) {
            showError('This is a development test link. In production, real SMS links will work properly.');
          }
          return;
        }
        
        // Validate token
        const { data: tokenData, error: tokenError } = await supabase
          .from('appointment_tokens')
          .select('*')
          .eq('token', token)
          .gte('expires_at', new Date().toISOString())
          .single();

        if (tokenError || !tokenData) {
          console.error('Token lookup error:', tokenError);
          if (!silentRefresh) {
            showError('This tracking link is invalid or has expired.');
          }
          return;
        }

        const { appointment_id, shop_id, short_code } = tokenData;
        
        // Store shop_id globally for estimate approval/decline functions
        window.currentShopId = shop_id;
        window.currentShortCode = short_code;


        // Fetch appointment directly from appointments table (if needed)
        // For now, keep using the data table for appointments, but fetch invoice from invoices table
        const { data: dataRow, error: dataError } = await supabase
          .from('data')
          .select('appointments')
          .eq('shop_id', shop_id)
          .single();

        if (dataError || !dataRow) {
          if (!silentRefresh) {
            showError('Unable to load appointment data.');
          }
          return;
        }

        const appointment = (dataRow.appointments || []).find(apt => apt.id === appointment_id);

        if (!appointment) {
          if (!silentRefresh) {
            showError('Appointment not found.');
          }
          return;
        }

        // Fetch invoice directly from invoices table
        const { data: invoiceRows, error: invoiceError } = await supabase
          .from('invoices')
          .select('*')
          .eq('shop_id', shop_id)
          .eq('appointment_id', appointment_id);

        if (invoiceError || !invoiceRows || invoiceRows.length === 0) {
          if (!silentRefresh) {
            showError('Invoice not found.');
          }
          return;
        }
        const invoice = invoiceRows[0];

        // Render tracking
        renderTracking(appointment, short_code, invoice);

        // Store current token for polling
        currentToken = token;

        // Switch screens (only on initial load, not refresh)
        if (!silentRefresh) {
          loadingState.style.display = 'none';
          errorState.style.display = 'none';
          trackingDisplay.style.display = 'block';
          
          // Start polling for updates
          startPolling();
        }

      } catch (err) {
        console.error('Error loading tracking:', err);
        if (!silentRefresh) {
          showError('System error. Please try again later.');
        }
      }
    }

    function renderTracking(appointment, code, invoice) {
      // Vehicle info
      const vehicleDisplay = appointment.vehicle || 'Vehicle';
      document.getElementById('vehicleInfo').textContent = vehicleDisplay;
      document.getElementById('displayCode').textContent = code || '';
      // Store invoice id globally for Approve All
      if (invoice && invoice.id) {
        window.currentInvoiceId = invoice.id;
      }

      // Status
      const status = (appointment.status || 'scheduled').toLowerCase();
      const statusBadge = document.getElementById('statusBadge');
      statusBadge.textContent = status.replace('-', ' ').replace('_', ' ');
      statusBadge.className = 'status-badge ' + status;

      // Status details
      document.getElementById('techName').textContent = appointment.tech_name || 'Not assigned';
      document.getElementById('scheduledDate').textContent = appointment.preferred_date 
        ? new Date(appointment.preferred_date).toLocaleDateString('en-US', { 
            weekday: 'short', 
            month: 'short',
            day: 'numeric'
          })
        : '-';
      document.getElementById('estimatedCompletion').textContent = appointment.estimated_completion || 'TBD';

      // === SERVICES SECTION ===
      const servicesList = document.getElementById('servicesList');
      let servicesHtml = '';
      // Check invoice for pending/approved estimates
      let pendingEstimates = [];
      let approvedItems = [];
      let hasUnapproved = false;
      let mainServiceItem = null;
      // --- Labor-based service grouping (match invoices page logic) ---
      let usedLaborIndexes = new Set();
      let serviceLaborMap = {};
      if (invoice && invoice.items) {
        invoice.items.forEach((item, idx) => {
          if ((item.type || '').toLowerCase() === 'labor' && (item._attached || item.linkedItemId)) {
            // Find the service this labor is attached to
            let svcIdx = -1;
            if (item.linkedItemId) {
              svcIdx = invoice.items.findIndex(svc => svc.id === item.linkedItemId);
            } else if (idx > 0 && invoice.items[idx-1].type === 'service' && invoice.items[idx-1]._hasAttachedLabor) {
              svcIdx = idx-1;
            }
            if (svcIdx >= 0) {
              serviceLaborMap[svcIdx] = serviceLaborMap[svcIdx] || [];
              serviceLaborMap[svcIdx].push({item, idx});
              usedLaborIndexes.add(idx);
            }
          }
        });
        // Find the originally booked service in invoice items (by name, or use a better identifier if available)
        if (appointment.service) {
          mainServiceItem = invoice.items.find(item => {
            if (item.service_id && appointment.service_id) {
              return item.service_id === appointment.service_id;
            }
            return (item.name || '').trim().toLowerCase() === appointment.service.trim().toLowerCase();
          });
        }
        // Only show accept/decline for items that are not approved
        pendingEstimates = invoice.items.filter(item => {
          const itemType = (item.type || '').toLowerCase();
          if (itemType === 'part' || itemType === 'labor') return false;
          // Use new item_status logic for pending
          if (item.item_status === 'approved' || item.approved_at) return false;
          // Fallback to legacy logic for backward compatibility
          return item.estimate_status === 'pending' || item.estimate_status === undefined || item.estimate_status === null || item.accept === false || (item.approved !== true && item.accept !== true);
        });
        // Only show in approved section if explicitly approved/accepted (new logic)
        approvedItems = invoice.items.filter(item => {
          const itemType = (item.type || '').toLowerCase();
          if (itemType === 'part' || itemType === 'labor') return false;
          return item.item_status === 'approved' || !!item.approved_at || item.estimate_status === 'approved' || item.approved === true || item.accept === true;
        });
        hasUnapproved = pendingEstimates.length > 0;
      }
      
      // Show notification banner for pending estimates
      if (pendingEstimates.length > 0) {
        document.getElementById('notificationBanner').style.display = 'block';
        document.getElementById('notificationTitle').textContent = `üîî New Estimate! (${pendingEstimates.length} item${pendingEstimates.length > 1 ? 's' : ''})`;
        document.getElementById('notificationMessage').textContent = 'Please accept or decline below.';
      } else {
        document.getElementById('notificationBanner').style.display = 'none';
      }

      // Show/hide Approve All button
      const approveAllBtn = document.getElementById('approveAllBtn');
      if (approveAllBtn) {
        if (hasUnapproved) {
          approveAllBtn.style.display = 'block';
          approveAllBtn.disabled = false;
        } else {
          approveAllBtn.style.display = 'none';
        }
      }
          // Approve All logic
          document.getElementById('approveAllBtn').onclick = async function() {
            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Processing...';
            try {
              // Fetch latest invoice data from invoices table
              const { data: invoiceRows, error: fetchError } = await supabase
                .from('invoices')
                .select('*')
                .eq('shop_id', window.currentShopId)
                .eq('id', window.currentInvoiceId || window.lastInvoiceId || '');
              if (fetchError || !invoiceRows || invoiceRows.length === 0) throw new Error('Failed to load invoice data');
              const invoice = invoiceRows[0];
              if (!invoice || !invoice.items) throw new Error('Invoice not found');
              
              const now = new Date().toISOString();
              let changed = false;
              
              // Approve ALL items (services AND their attached labor)
              invoice.items.forEach(item => {
                const itemType = (item.type || '').toLowerCase();
                // Skip parts but include labor (attached to services)
                if (itemType === 'part') return;
                
                // Check if already approved
                if (item.item_status === 'approved' && item.approved_at) return;
                
                // Set ALL approval fields to match invoice modal behavior
                item.estimate_status = 'approved';
                item.estimate_approved_at = now;
                item.item_status = 'approved';
                item.approved_at = now;
                item.approved = true;
                item.accept = true;
                changed = true;
              });
              
              // If any changes, set invoice status to open invoice
              if (changed) {
                invoice.status = 'open invoice';
              } else {
                throw new Error('No unapproved items found');
              }
              
              // Save to invoices table
              const { error: updateError } = await supabase
                .from('invoices')
                .update({ 
                  items: invoice.items, 
                  status: invoice.status, 
                  updated_at: now 
                })
                .eq('id', invoice.id);
              if (updateError) throw updateError;
              
              // Also update the data table for backwards compatibility
              try {
                const { data: dataRow } = await supabase
                  .from('data')
                  .select('invoices')
                  .eq('shop_id', window.currentShopId)
                  .single();
                
                if (dataRow && dataRow.invoices) {
                  const dataInvoices = dataRow.invoices;
                  const dataInvIdx = dataInvoices.findIndex(inv => inv.id === invoice.id);
                  if (dataInvIdx !== -1) {
                    dataInvoices[dataInvIdx].items = invoice.items;
                    dataInvoices[dataInvIdx].status = invoice.status;
                    dataInvoices[dataInvIdx].updated_at = now;
                    await supabase
                      .from('data')
                      .update({ invoices: dataInvoices, updated_at: now })
                      .eq('shop_id', window.currentShopId);
                    console.log('‚úÖ Also updated data table');
                  }
                }
              } catch (dataErr) {
                console.warn('Could not update data table (non-critical):', dataErr);
              }
              
              console.log('‚úÖ All items approved successfully');
              btn.textContent = 'Approved!';
              setTimeout(() => { btn.style.display = 'none'; }, 1200);
              if (currentToken) await loadTracking(currentToken, true);
            } catch (err) {
              console.error('Error in Approve All:', err);
              btn.disabled = false;
              btn.textContent = '‚úÖ Approve All & Open Invoice';
              alert('Failed to approve all: ' + (err.message || err));
            }
          };
      
      // 1. PENDING ESTIMATES FIRST (combine labor if present)
      pendingEstimates.forEach((item) => {
        const idx = invoice.items.indexOf(item);
        const qty = parseFloat(item.qty || 1) || 1;
        let price = parseFloat(item.price || item.unit_price || 0) || 0;
        let laborTotal = 0;
        // If labor-based, sum attached labor
        if (item.pricing_type === 'labor_based' || serviceLaborMap[idx]) {
          (serviceLaborMap[idx] || []).forEach(({item: laborItem, idx: laborIdx}) => {
            laborTotal += parseFloat(laborItem.price || laborItem.unit_price || 0) || 0;
            usedLaborIndexes.add(laborIdx);
          });
        }
        const itemTotal = qty * (price + laborTotal);
        const itemIdx = idx;
        servicesHtml += `
          <div class="service-item" style="background:#fef3c7;border-left:4px solid #f59e0b;padding:16px;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;flex-wrap:wrap;">
            <span class="service-icon" style="color:#f59e0b;font-size:1.5rem;">‚è≥</span>
            <div style="flex:1;min-width:200px;">
              <div style="font-weight:600;font-size:1.1rem;">${item.name || '-'}</div>
              <div style="font-size:0.875rem;color:#78716c;">${qty > 1 ? qty + ' x ' : ''}$${(price + laborTotal).toFixed(2)} = <strong>$${itemTotal.toFixed(2)}</strong></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;width:100%;">
              <button onclick="approveEstimate('${invoice.id}', ${itemIdx})" style="flex:1;background:#10b981;color:white;padding:12px 24px;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">‚úì Accept</button>
              <button onclick="declineEstimate('${invoice.id}', ${itemIdx})" style="flex:1;background:#ef4444;color:white;padding:12px 24px;font-weight:600;border:none;border-radius:8px;cursor:pointer;font-size:1rem;">‚úó Decline</button>
            </div>
          </div>
        `;
      });

      // 2. Original appointment service (only if it exists in invoice, combine labor if present)
      // Only auto-approve the originally booked service if it exists. If deleted, do not auto-approve any other service.
      if (mainServiceItem) {
        let mainIcon = '‚úì';
        let mainStatus = 'Approved';
        let mainColor = '#10b981';
        if (status === 'completed') {
          mainStatus = 'Complete';
        } else if (status === 'in-progress' || status === 'in_progress') {
          mainIcon = 'üîß';
          mainStatus = 'In Progress';
          mainColor = '#3b82f6';
        }
        const idx = invoice.items.indexOf(mainServiceItem);
        let price = parseFloat(mainServiceItem.price || mainServiceItem.unit_price || 0) || 0;
        let laborTotal = 0;
        if (mainServiceItem.pricing_type === 'labor_based' || serviceLaborMap[idx]) {
          (serviceLaborMap[idx] || []).forEach(({item: laborItem, idx: laborIdx}) => {
            laborTotal += parseFloat(laborItem.price || laborItem.unit_price || 0) || 0;
            usedLaborIndexes.add(laborIdx);
          });
        }
        const qty = parseFloat(mainServiceItem.qty || 1) || 1;
        const itemTotal = qty * (price + laborTotal);
        servicesHtml += `
          <div class="service-item" style="background:#f0fdf4;border-left:4px solid #10b981;padding:12px;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;">
            <span class="service-icon">${mainIcon}</span>
            <span class="service-name" style="flex:1;font-weight:600;">${mainServiceItem.name || appointment.service}</span>
            <span style="color:${mainColor};font-weight:600;">$${itemTotal.toFixed(2)} ${mainStatus}</span>
          </div>
        `;
      }

      // 3. Other approved estimate items (excluding mainServiceItem if present, combine labor if present)
      approvedItems.forEach(item => {
        // Only skip mainServiceItem if it exists; do not auto-approve any other service if mainServiceItem is deleted
        if (mainServiceItem && item === mainServiceItem) return;
        const idx = invoice.items.indexOf(item);
        const qty = parseFloat(item.qty || 1) || 1;
        let price = parseFloat(item.price || item.unit_price || 0) || 0;
        let laborTotal = 0;
        if (item.pricing_type === 'labor_based' || serviceLaborMap[idx]) {
          (serviceLaborMap[idx] || []).forEach(({item: laborItem, idx: laborIdx}) => {
            laborTotal += parseFloat(laborItem.price || laborItem.unit_price || 0) || 0;
            usedLaborIndexes.add(laborIdx);
          });
        }
        const itemTotal = qty * (price + laborTotal);
        servicesHtml += `
          <div class="service-item" style="background:#f0fdf4;border-left:4px solid #10b981;padding:12px;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;">
            <span class="service-icon">‚úì</span>
            <div style="flex:1;">
              <div style="font-weight:600;">${item.name || '-'}</div>
              <div style="font-size:0.875rem;color:#78716c;">${qty > 1 ? qty + ' x ' : ''}$${(price + laborTotal).toFixed(2)} = $${itemTotal.toFixed(2)}</div>
            </div>
            <span style="color:#10b981;font-weight:600;">Approved</span>
          </div>
        `;
      });

      // If no services, show a message
      if (!pendingEstimates.length && !approvedItems.length && !mainServiceItem) {
        servicesHtml = '<div style="color:#64748b;text-align:center;padding:24px 0;">No services on this invoice yet.</div>';
      }

      servicesList.innerHTML = servicesHtml;
      
      // Render Misc Parts & Labor section
      const miscSection = document.getElementById('miscSection');
      const miscTotal = document.getElementById('miscTotal');
      if (invoice && invoice.items) {
        // Exclude labor items that are associated with a service (usedLaborIndexes)
        const miscItems = invoice.items.filter((item, idx) => {
          const itemType = (item.type || '').toLowerCase();
          if (itemType === 'labor' && usedLaborIndexes.has(idx)) return false;
          return itemType === 'part' || itemType === 'labor' || itemType === 'inventory';
        });
        if (miscItems.length > 0) {
          let miscSum = 0;
          miscItems.forEach(item => {
            const qty = parseFloat(item.qty || 1) || 1;
            const price = parseFloat(item.price || item.unit_price || 0) || 0;
            miscSum += qty * price;
          });
          miscTotal.textContent = '$' + miscSum.toFixed(2);
          miscSection.style.display = 'block';
        } else {
          miscSection.style.display = 'none';
        }
      } else {
        miscSection.style.display = 'none';
      }
      
      // Render Invoice
      const invoiceSection = document.getElementById('invoiceSection');
      const invoiceList = document.getElementById('invoiceList');
      const invoiceTotalEl = document.getElementById('invoiceTotal');
      
      if (invoice && invoice.items && invoice.items.length > 0) {
        const filteredItems = (invoice.items || []).filter(item => {
          const itemType = (item.type || '').toLowerCase();
          if (itemType === 'part' || itemType === 'labor') return false;
          // Only show if approved (new logic)
          if (item.item_status === 'approved' || item.approved_at) return true;
          // Fallback to legacy logic for backward compatibility
          if (item.estimate_status === 'approved' || item.approved === true || item.accept === true) return true;
          return false;
        });
        
        if (filteredItems.length > 0) {
          let invoiceHtml = '';
          let subtotal = 0;
          filteredItems.forEach((item, idx) => {
            // Always use index from invoice.items for labor lookup
            const origIdx = invoice.items.indexOf(item);
            let qty = parseFloat(item.qty || 1) || 1;
            let price = parseFloat(item.price || item.unit_price || 0) || 0;
            let laborTotal = 0;
            if ((item.type || '').toLowerCase() === 'service' && (item.pricing_type === 'labor_based' || serviceLaborMap[origIdx])) {
              (serviceLaborMap[origIdx] || []).forEach(({item: laborItem, idx: laborIdx}) => {
                const laborQty = parseFloat(laborItem.qty || 1) || 1;
                const laborPrice = parseFloat(laborItem.price || laborItem.unit_price || 0) || 0;
                laborTotal += laborQty * laborPrice;
              });
            }
            // Exclude labor rows that are attached to a service
            if ((item.type || '').toLowerCase() === 'labor' && usedLaborIndexes.has(origIdx)) return;
            const itemType = (item.type || '').toLowerCase() === 'service' ? 'Service' : 'Item';
            const itemTotal = qty * (price + laborTotal);
            subtotal += itemTotal;
            invoiceHtml += `
              <div class="invoice-item">
                <div class="invoice-description">
                  <label>${itemType}</label>
                  <div class="name">${item.name || '-'}</div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 0.875rem; color: var(--muted); margin-bottom: 4px;">
                    ${qty > 1 ? qty + ' x ' : ''}$${(price + laborTotal).toFixed(2)}
                  </div>
                  <div class="invoice-amount">$${itemTotal.toFixed(2)}</div>
                </div>
              </div>
            `;
          });
          
          invoiceList.innerHTML = invoiceHtml;
          
          // Calculate totals with tax/discount
          let tax = 0;
          let discount = 0;
          
          // Add misc to subtotal
          const miscItems = (invoice.items || []).filter((item, idx) => {
            const itemType = (item.type || '').toLowerCase();
            if (itemType === 'labor' && usedLaborIndexes.has(idx)) return false;
            return itemType === 'part' || itemType === 'labor' || itemType === 'inventory';
          });
          let miscSum = 0;
          miscItems.forEach(item => {
            const qty = parseFloat(item.qty || 1) || 1;
            const price = parseFloat(item.price || item.unit_price || 0) || 0;
            miscSum += qty * price;
          });
          
          const grandSubtotal = subtotal + miscSum;
          
          if (invoice.tax_rate) {
            tax = grandSubtotal * (parseFloat(invoice.tax_rate) / 100);
          }
          if (invoice.discount) {
            discount = parseFloat(invoice.discount) || 0;
          }
          
          const total = grandSubtotal + tax - discount;
          invoiceTotalEl.textContent = '$' + total.toFixed(2);
          invoiceSection.style.display = 'block';
        } else {
          // Check if misc items exist
          const miscItems = (invoice.items || []).filter(item => {
            const itemType = (item.type || '').toLowerCase();
            return itemType === 'part' || itemType === 'labor' || itemType === 'inventory';
          });
          
          if (miscItems.length > 0) {
            let miscSum = 0;
            miscItems.forEach(item => {
              const qty = parseFloat(item.qty || 1) || 1;
              const price = parseFloat(item.price || item.unit_price || 0) || 0;
              miscSum += qty * price;
            });
            
            let tax = 0;
            let discount = 0;
            if (invoice.tax_rate) {
              tax = miscSum * (parseFloat(invoice.tax_rate) / 100);
            }
            if (invoice.discount) {
              discount = parseFloat(invoice.discount) || 0;
            }
            
            const total = miscSum + tax - discount;
            invoiceList.innerHTML = '';
            invoiceTotalEl.textContent = '$' + total.toFixed(2);
            invoiceSection.style.display = 'block';
          } else {
            invoiceSection.style.display = 'none';
          }
        }
      } else {
        invoiceSection.style.display = 'none';
      }
    }
    
    // Global functions for estimate approval/decline
    window.approveEstimate = async function(invoiceId, itemIdx) {
      const btn = event.target;
      try {
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        // Fetch invoice directly from invoices table
        const { data: invoiceRows, error: fetchError } = await supabase
          .from('invoices')
          .select('*')
          .eq('shop_id', window.currentShopId)
          .eq('id', invoiceId);
        if (fetchError || !invoiceRows || invoiceRows.length === 0) {
          throw new Error('Failed to load invoice data');
        }
        const invoice = invoiceRows[0];
        if (!invoice || !invoice.items || !invoice.items[itemIdx]) {
          throw new Error('Invoice or item not found');
        }
        
        const now = new Date().toISOString();
        const item = invoice.items[itemIdx];
        
        // Set ALL approval fields to match invoice modal behavior
        item.estimate_status = 'approved';
        item.estimate_approved_at = now;
        item.item_status = 'approved';
        item.approved_at = now;
        item.approved = true;
        item.accept = true;
        
        // Also approve any attached labor rows for this service
        if ((item.type || '').toLowerCase() === 'service') {
          invoice.items.forEach((otherItem, otherIdx) => {
            if (otherIdx === itemIdx) return;
            // Check if this is attached labor
            if ((otherItem.type || '').toLowerCase() === 'labor') {
              const isAttached = otherItem.linkedItemId === item.id || 
                                 otherItem._attached || 
                                 (otherIdx === itemIdx + 1 && otherItem._attached);
              if (isAttached) {
                otherItem.estimate_status = 'approved';
                otherItem.estimate_approved_at = now;
                otherItem.item_status = 'approved';
                otherItem.approved_at = now;
                otherItem.approved = true;
                otherItem.accept = true;
                console.log('‚úÖ Also approved attached labor at index', otherIdx);
              }
            }
          });
        }
        
        // Save to invoices table
        const { error: updateError } = await supabase
          .from('invoices')
          .update({ 
            items: invoice.items, 
            updated_at: now 
          })
          .eq('id', invoice.id);
        if (updateError) throw updateError;
        
        // Also update the data table for backwards compatibility
        try {
          const { data: dataRow } = await supabase
            .from('data')
            .select('invoices')
            .eq('shop_id', window.currentShopId)
            .single();
          
          if (dataRow && dataRow.invoices) {
            const dataInvoices = dataRow.invoices;
            const dataInvIdx = dataInvoices.findIndex(inv => inv.id === invoiceId);
            if (dataInvIdx !== -1) {
              dataInvoices[dataInvIdx].items = invoice.items;
              dataInvoices[dataInvIdx].updated_at = now;
              await supabase
                .from('data')
                .update({ invoices: dataInvoices, updated_at: now })
                .eq('shop_id', window.currentShopId);
              console.log('‚úÖ Also updated data table');
            }
          }
        } catch (dataErr) {
          console.warn('Could not update data table (non-critical):', dataErr);
        }
        
        console.log('‚úÖ Item approved successfully');
        if (currentToken) {
          await loadTracking(currentToken, true);
        }
      } catch (error) {
        console.error('Error approving estimate:', error);
        alert('Failed to approve estimate. Please try again.');
        if (btn) {
          btn.disabled = false;
          btn.textContent = '‚úì Accept';
        }
      }
    };
    
    let pendingDecline = null;
    
    window.declineEstimate = function(invoiceId, itemIdx) {
      pendingDecline = { invoiceId, itemIdx };
      const modal = document.getElementById('confirmModal');
      modal.style.display = 'flex';
    };
    
    document.getElementById('confirmCancel').addEventListener('click', function() {
      pendingDecline = null;
      document.getElementById('confirmModal').style.display = 'none';
    });
    
    document.getElementById('confirmYes').addEventListener('click', async function() {
      if (!pendingDecline) return;
      
      const { invoiceId, itemIdx } = pendingDecline;
      const btn = this;
      
      try {
        btn.disabled = true;
        btn.textContent = 'Removing...';
        
        const now = new Date().toISOString();
        
        // Fetch invoice from invoices table (primary source)
        const { data: invoiceRows, error: fetchError } = await supabase
          .from('invoices')
          .select('*')
          .eq('shop_id', window.currentShopId)
          .eq('id', invoiceId);
        
        if (fetchError || !invoiceRows || invoiceRows.length === 0) {
          throw new Error('Failed to load invoice data');
        }
        
        const invoice = invoiceRows[0];
        
        if (!invoice || !invoice.items) {
          throw new Error('Invoice not found');
        }
        
        // Get the item being declined to check for attached labor
        const declinedItem = invoice.items[itemIdx];
        const declinedItemId = declinedItem?.id;
        
        // Remove the declined item
        invoice.items.splice(itemIdx, 1);
        
        // Also remove any attached labor rows for this service
        if (declinedItemId && (declinedItem.type || '').toLowerCase() === 'service') {
          invoice.items = invoice.items.filter(item => {
            if ((item.type || '').toLowerCase() !== 'labor') return true;
            // Remove if linked to the declined service
            if (item.linkedItemId === declinedItemId) {
              console.log('‚ùå Also removing attached labor');
              return false;
            }
            return true;
          });
        }
        
        // Save to invoices table
        const { error: updateError } = await supabase
          .from('invoices')
          .update({ 
            items: invoice.items,
            updated_at: now
          })
          .eq('id', invoiceId);
        
        if (updateError) throw updateError;
        
        // Also update the data table for backwards compatibility
        try {
          const { data: dataRow } = await supabase
            .from('data')
            .select('invoices')
            .eq('shop_id', window.currentShopId)
            .single();
          
          if (dataRow && dataRow.invoices) {
            const dataInvoices = dataRow.invoices;
            const dataInvIdx = dataInvoices.findIndex(inv => inv.id === invoiceId);
            if (dataInvIdx !== -1) {
              dataInvoices[dataInvIdx].items = invoice.items;
              dataInvoices[dataInvIdx].updated_at = now;
              await supabase
                .from('data')
                .update({ invoices: dataInvoices, updated_at: now })
                .eq('shop_id', window.currentShopId);
              console.log('‚úÖ Also updated data table');
            }
          }
        } catch (dataErr) {
          console.warn('Could not update data table (non-critical):', dataErr);
        }
        
        console.log('‚ùå Item declined and removed');
        
        document.getElementById('confirmModal').style.display = 'none';
        pendingDecline = null;
        btn.disabled = false;
        btn.textContent = 'Yes, Decline';
        
        if (currentToken) {
          await loadTracking(currentToken, true);
        }
      } catch (error) {
        console.error('Error declining estimate:', error);
        alert('Failed to decline estimate. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Yes, Decline';
      }
    });

    // Initialize - get token from URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    if (!token) {
      showError('No tracking link provided. Please use the link sent to your phone.');
    } else {
      loadTracking(token);
    }
  </script>
</body>
</html>
