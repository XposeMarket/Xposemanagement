<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Appointments</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* tiny, surgical additions */
    .pill-save {
      display:inline-flex; align-items:center; gap:6px;
      background:#1677ff; color:#fff; border:none;
      padding:4px 10px; border-radius:999px; cursor:pointer;
      font-size:.85em; line-height:1; white-space:nowrap;
      box-shadow:0 1px 2px rgba(0,0,0,.08);
    }
.pill-save.saved { background:#6b7280; color:#fff; opacity:.95; }
    .pill-save:disabled { opacity:.6; cursor:not-allowed; }
    .pill-save .dot { width:6px; height:6px; border-radius:50%; background:#fff; opacity:.9; }

    /* Split toolbars: left action group + right Save Customer */
    .splitbar { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .splitbar .left { display:flex; align-items:center; gap:8px; }
    .splitbar .right { display:flex; align-items:center; gap:8px; }

    /* Align modals below the sticky header on desktop, but keep them centered on small screens */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      align-items: flex-start; /* sit below header */
      padding-top: 56px; /* account for header height (reduced to open higher) */
      justify-content: center;
      z-index: 10020;
      overflow: auto;
    }
    .modal-card {
      width: min(640px, 92vw);
      background: var(--card, #fff);
      color: inherit;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      margin: 12px 0; /* ensure some breathing room when content is tall */
    }

    @media (max-width: 768px) {
      .modal-backdrop { align-items: center; padding-top: 0; }
    }
    /* Restore standard modal scrolling so modals scroll internally on small screens
       instead of growing past the viewport. Keep a sensible max-height on the card. */
    .modal-backdrop .modal-card {
      max-height: calc(90vh);
    }
    .modal-backdrop .modal-card .modal-body {
      overflow: auto !important;
      max-height: calc(80vh - 120px) !important;
    }
    .modal-head { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border,#e5e5e5); }
    .modal-body { padding:12px 14px; }
    .modal-foot { display:flex; justify-content:flex-end; gap:8px; padding:12px 14px; border-top:1px solid var(--border,#e5e5e5); }
    .btn-close { background: none; border: none; font-size: 24px; cursor: pointer; color: inherit; }
    .notification { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .hidden { display:none; }
  </style>
</head>
<body>
<header class="top">
  <div class="container row top row">
    <a class="brand" href="dashboard.html" aria-label="Home">
      <img id="headerLogo" src="assets/XposeManagementCRMlogo.png" alt="Logo">
    </a>
    <button id="menuToggle" class="menu-toggle" aria-label="Toggle menu"><span></span><span></span><span></span></button><nav id="mainNav">
      <a href="dashboard.html" class="">Dashboard</a>
      <a href="appointments.html" class="active">Appointments</a>
      <a href="jobs.html" class="">Jobs</a>
      <a href="messages.html" class="">Messages</a>
      <a href="invoices.html" class="">Invoices</a>
      <a href="customers.html" class="">Customers</a>
      <a href="revenue.html" class="">Revenue</a>
      <a href="inventory.html" class="" id="inventoryNavLink" style="display:none">Inventory</a>
      <a href="settings.html" class="">Settings</a>
      <a href="profile.html" class="">Profile</a>
      <a href="#" id="mobileThemeToggle" class="mobile-nav-btn mobile-special">Theme</a>
      <a href="#" id="mobileLogoutBtn" class="mobile-nav-btn mobile-special">Logout</a>
    </nav>
    <!-- Shop switcher removed -->
    <div id="notification" class="notification hidden"></div>
    <div>
      <button id="themeToggle" class="btn" aria-label="Toggle theme">Theme</button>
      <button id="logoutBtn" class="btn" aria-label="Logout">Logout</button>
    </div>
  </div>
</header>

<main class="container" style="padding:16px 0">
  <h1>Appointments</h1>
  <div class="card">
    <div class="toolbar">
  <button id="newAppt" class="btn info">New Appointment</button>
      <input id="apptSearch" placeholder="Searchâ€¦">
      <select id="apptStatus">
        <option value="">All Statuses</option>
        <option>new</option><option>scheduled</option><option>in_progress</option>
        <option>awaiting_parts</option><option>completed</option>
      </select>
      <button id="apptFilter" class="btn">Apply</button>
    </div>

    <table class="table" id="apptTable">
      <thead>
        <tr>
          <th data-col="created" class="sortable">Created</th>
          <th data-col="customer" class="sortable">Customer</th>
          <th data-col="vehicle" class="sortable">Vehicle</th>
          <th data-col="service" class="sortable">Service</th>
          <th data-col="scheduled" class="sortable">Scheduled</th>
          <th data-col="time" class="sortable">Time</th>
          <th data-col="status" class="sortable">Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="notice" id="apptEmpty"></p>
  </div>
</main>

<!-- ===== Quick New modal (kept) ===== -->
<div id="newApptModal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3>New Appointment</h3>
      <button id="closeAppt" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <div class="grid cols-2">
        <div><label>First name</label><input id="naFirst"></div>
        <div><label>Last name</label><input id="naLast"></div>
      </div>

      <label>Email (optional)</label><input id="naEmail" type="email">
      <label>Phone</label><input id="naPhone">

      <div class="grid cols-3">
        <div>
          <label>Year</label>
          <select id="naVehicleYear">
            <option value="">Year</option>
          </select>
        </div>
        <div>
          <label>Make</label>
          <select id="naVehicleMake">
            <option value="">Make</option>
          </select>
        </div>
        <div>
          <label>Model</label>
          <select id="naVehicleModel">
            <option value="">Model</option>
          </select>
        </div>
      </div>
      <div class="grid cols-2">
        <div style="margin-top:8px">
          <label>VIN (optional)</label>
          <input id="naVin" maxlength="17" placeholder="17 characters">
        </div>
        <div>
          <label>Service</label>
          <input id="naService" list="svcOptions" autocomplete="off">
          <datalist id="svcOptions"></datalist>
        </div>
        <div><label>Date</label><input id="naDate" type="date"></div>
      </div>

      <label>Time</label><input id="naTime" type="time">
    </div>
    <div class="modal-foot">
      <div class="splitbar" style="width:100%; margin:0; padding:0; border:0">
        <div class="left">
          <button id="saveAppt" class="btn info">Save</button>
        </div>
        <div class="right">
          <button id="saveCustNew" class="pill-save" title="Save customer for reuse">
            <span class="dot"></span> Save Customer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


<div id="deleteApptModal" class="modal-backdrop hidden">
  <div class="modal-card" style="max-width:340px">
    <div class="modal-head">
      <h3>Delete Appointment</h3>
      <button id="deleteApptModalClose" class="btn-close" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body" style="text-align:center">
      <p id="deleteApptMsg">Are you sure you want to delete this appointment?</p>
    </div>
    <div class="modal-foot" style="justify-content:center">
      <button id="deleteApptModalCancel" class="btn">Cancel</button>
      <button id="deleteApptModalConfirm" class="btn danger">Delete</button>
    </div>
  </div>
</div>

<footer class="container">Â© Xpose Market</footer>

<!-- Edit Appointment Modal -->

<!-- Edit Service (Appointments) -->
<div id="editSvcModal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3>Edit Service</h3>
      <button id="closeEditSvc" class="btn">Close</button>
    </div>
    <div class="modal-body">
      <label>Service</label>
      <input id="esService" placeholder="Service name">
      <div class="grid cols-3">
        <div>
          <label>Parts $</label>
          <input id="esParts" type="number" step="0.01">
        </div>
        <div>
          <label>Labor $/hr</label>
          <div class="row" style="display:flex;gap:8px">
            <input id="esLabor" type="number" step="0.01">
            <button id="esPickRate" class="btn">Choose rate</button>
          </div>
        </div>
        <div>
          <label>Hours</label>
          <input id="esHours" type="number" step="0.25">
        </div>
      </div>
      <p id="esNotice" class="notice"></p>
    </div>
    <div class="modal-foot">
      <button id="saveEditSvc" class="btn info">Save</button>
    </div>
  </div>
</div>

<script src="vendor/supabase.umd.js"></script>
<script type="module">
  // Import and set up UUID generator globally
  import { getUUID } from './helpers/uuid.js';
  window.getUUID = getUUID;
</script>
<script type="module" src="app.js"></script>
<script src="multi-tenant.js"></script>
<script src="helpers/tracking-code-generator.js"></script>
<script src="helpers/appointment-tracker.js"></script>

<!-- ===== Appointment Modal (Create/Edit unified) ===== -->
<div id="apptModal" class="modal-backdrop hidden">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="apptModalTitle">Edit Appointment</h3>
      <button type="button" class="btn" id="closeApptModal">Close</button>
    </div>
    <div class="modal-body">
      <form id="apptForm">
        <div class="grid cols-2">
          <div>
            <label>First Name</label>
            <input name="customer_first" placeholder="First Name">
          </div>
          <div>
            <label>Last Name</label>
            <input name="customer_last" placeholder="Last Name">
          </div>
          <div>
            <label>Phone</label>
            <input name="phone" placeholder="(555) 555-5555">
          </div>
          <div>
            <label>Email</label>
            <input name="email" type="email" placeholder="email@example.com">
          </div>
          <div class="grid cols-3" style="grid-column: 1 / -1;">
            <div>
              <label>Year</label>
              <select name="vehicle_year" id="vehicleYear">
                <option value="">Select Year</option>
              </select>
            </div>
            <div>
              <label>Make</label>
              <select name="vehicle_make" id="vehicleMake">
                <option value="">Select Make</option>
              </select>
            </div>
            <div>
              <label>Model</label>
              <select name="vehicle_model" id="vehicleModel">
                <option value="">Select Model</option>
              </select>
            </div>
          </div>
          <div>
            <label>VIN (optional)</label>
            <input id="apptVin" name="vin" maxlength="17" placeholder="17 characters">
          </div>
          <div>
            <label>Service</label>
            <input name="service" list="svcOptions" placeholder="Oil Change" autocomplete="off">
          </div>
          <div>
            <label>Date</label>
            <input type="date" name="preferred_date">
          </div>
          <div>
            <label>Time</label>
            <input type="time" name="preferred_time">
          </div>
        </div>

        <!-- Tracking Code Display -->
        <div id="trackingCodeSection" style="grid-column: 1 / -1; display: none;">
          <label>Tracking Code</label>
          <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
            <div id="trackingCodeDisplay" style="font-family: 'Courier New', monospace; font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; user-select: all; cursor: pointer;" title="Click to copy"></div>
            <button type="button" id="copyTrackingCodeBtn" class="btn" style="padding: 8px 12px;" title="Copy to clipboard">
              ðŸ“‹ Copy
            </button>
          </div>
          <p style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">Give this code to customer for status tracking</p>
        </div>

        <!-- Notes Section -->
        <div style="grid-column: 1 / -1;">
          <label>Notes</label>
          <div id="appointmentNotesList" style="display: flex; flex-direction: column; gap: 12px; margin-top: 8px;">
            <!-- Notes will be dynamically loaded here -->
          </div>
          <button type="button" id="addNoteBtn" class="btn" style="margin-top: 12px; width: 100%;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Note
          </button>
        </div>
      </form>
    </div>
    <div class="modal-foot">
      <div style="display:flex; gap:8px; justify-content:space-between; width:100%;">
        <div style="display:flex; gap:8px;">
          <button type="submit" form="apptForm" class="btn info">Save</button>
          <button id="sendTrackingBtn" type="button" class="btn" style="background: #8b5cf6; color: white;" title="Send status tracker to customer">
            ðŸ“± Send Tracker
          </button>
        </div>
        <button id="saveCustEdit" type="button" class="pill-save" title="Save customer for reuse">
          <span class="dot"></span> Save Customer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===== Note Edit/Create Modal ===== -->
<div id="noteModal" class="modal-backdrop hidden">
  <div class="modal-card" style="max-width: 600px;">
    <div class="modal-head">
      <h3 id="noteModalTitle">Add Note</h3>
      <button type="button" class="btn" id="closeNoteModal">Close</button>
    </div>
    <div class="modal-body">
      <form id="noteForm">
        <label>Note</label>
        <textarea id="noteText" rows="4" placeholder="Enter note..." required></textarea>
      </form>
    </div>
    <div class="modal-foot">
      <button type="submit" form="noteForm" class="btn info">Save Note</button>
    </div>
  </div>
</div>

<!-- ===== Send Tracking Link Modal ===== -->
<div id="sendTrackingModal" class="modal-backdrop hidden">
  <div class="modal-card" style="max-width: 480px;">
    <div class="modal-head">
      <h3>ðŸ“± Send Status Tracker</h3>
      <button type="button" class="btn" id="closeSendTrackingModal">Close</button>
    </div>
    <div class="modal-body">
      <p style="margin: 0 0 16px; color: var(--muted);">
        Send a personalized tracking link via SMS to the customer's phone.
      </p>
      <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
        <div style="font-weight: 600; margin-bottom: 8px; font-size: 1.1rem;" id="trackingCustomerName"></div>
        <div style="display: flex; align-items: center; gap: 8px; font-size: 1rem;">
          <span style="font-size: 1.25rem;">ðŸ“±</span>
          <span id="trackingCustomerPhone" style="font-weight: 500;"></span>
        </div>
      </div>
      <div style="background: #f0fdf4; border: 1px solid #10b981; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
        <div style="display: flex; align-items: flex-start; gap: 10px;">
          <span style="font-size: 1.25rem;">âœ…</span>
          <div style="font-size: 0.875rem; color: #166534;">
            <strong>Personal Tracker Link</strong><br>
            Customer will receive a direct link to view their vehicle status in real-time. No code entry needed!
          </div>
        </div>
      </div>
      <p id="trackingModalError" style="margin: 16px 0 0; padding: 12px; background: #fee2e2; color: #991b1b; border-radius: 6px; font-size: 0.875rem; display: none;"></p>
    </div>
    <div class="modal-foot">
      <button type="button" id="confirmSendTracking" class="btn info" disabled>ðŸ“± Send SMS</button>
    </div>
  </div>
</div>

<!-- ===== Save Customer wiring (Phase 2A - Supabase integration) ===== -->
<script type="module">
import { upsertCustomerToSupabase } from './pages/appointments.js?v=1767390869';

(function(){
  const LS = window.LS || {users:"xm_users",session:"xm_session",data:"xm_data"};
  const $ = (s,root)=> (root||document).querySelector(s);
  const $$ = (s,root)=> Array.from((root||document).querySelectorAll(s));
  function readLS(k,f){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):(f??null);}catch(e){ return f??null; } }
  function writeLS(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
  function currentUser(){ const sess=readLS(LS.session, {})||{}; const users=readLS(LS.users, [])||[]; return users.find(u=>u.id===sess.user_id||u.email===sess.email)||sess.user||{}; }
  function myRole(){ return (currentUser().role||'').toLowerCase(); }
  function currentShopId(){ return currentUser().shop_id || (readLS('xm_shops', [])[0]?.id) || 'shop_demo'; }
  const isStaff = ()=> myRole()==='staff';

  function normPhone(s){ return (s||'').replace(/\D+/g,''); }
  function normEmail(s){ return (s||'').trim().toLowerCase(); }

  // Parse helpers
  function parseFullName(name){
    name=(name||'').trim(); if(!name) return {first:'',last:''};
    const parts=name.split(/\s+/); const first=parts.shift()||''; return {first,last:parts.join(' ')||''};
  }
  function parseYMM(str){
    const s=(str||'').trim(); if(!s) return {year:'',make:'',model:''};
    const parts=s.split(/\s+/);
    const year = /^\d{4}$/.test(parts[0]) ? parts.shift() : '';
    const make = parts.shift()||'';
    const model = parts.join(' ')||'';
    return {year,make,model};
  }

  // ðŸ†• Save customer to Supabase (delegates to appointments.js function)
  async function saveCustomerToSupabase({first_name, last_name, phone, email, vehicle, vehicle_year, vehicle_make, vehicle_model, vin, zipcode, notes}){
    try {
      const result = await upsertCustomerToSupabase({
        customer_first: first_name,
        customer_last: last_name,
        phone,
        email,
        vehicle,
        vehicle_year,
        vehicle_make,
        vehicle_model,
        vin,
        zipcode: zipcode || '',
        notes: notes || ''
      });
      return result;
    } catch (err) {
      console.error('âŒ Error saving customer to Supabase:', err);
      return null;
    }
  }

  // Make a stable signature of the fields to control the pill state
  function sigFromNew(){
    const first = $('#naFirst')?.value||'';
    const last  = $('#naLast')?.value||'';
    const email = $('#naEmail')?.value||'';
    const phone = $('#naPhone')?.value||'';
    const vehicle_year = $('#naVehicleYear')?.value||'';
    const vehicle_make = $('#naVehicleMake')?.value||'';
    const vehicle_model = $('#naVehicleModel')?.value||'';
    const vehicle = [vehicle_year, vehicle_make, vehicle_model].filter(v => v).join(' ') || '';
    const vin   = ($('#naVin')?.value||'');
    return [first,last,normEmail(email),normPhone(phone),vehicle,vin].join('||');
  }
  function sigFromEdit(){
    const name  = $('#apptForm [name="customer"]')?.value||'';
    const phone = $('#apptForm [name="phone"]')?.value||'';
    const email = $('#apptForm [name="email"]')?.value||'';
    const vehicle_year = $('#apptForm [name="vehicle_year"]')?.value||'';
    const vehicle_make = $('#apptForm [name="vehicle_make"]')?.value||'';
    const vehicle_model = $('#apptForm [name="vehicle_model"]')?.value||'';
    const vehicle = [vehicle_year, vehicle_make, vehicle_model].filter(v => v).join(' ') || '';
    const vin   = ($('#apptVin')?.value||'');
    return [name,normPhone(phone),email,vehicle,vin].join('||');
  }

  function setSaved(btn){
    if(!btn) return;
    btn.classList.add('saved');
    btn.disabled = true;
    btn.innerHTML = '<span class="dot"></span> Saved';
    btn.dataset.saved = '1';
  }
  function setUnsaved(btn){
    if(!btn) return;
    btn.classList.remove('saved');
    btn.disabled = false;
    btn.innerHTML = '<span class="dot"></span> Save Customer';
    btn.dataset.saved = '0';
  }

  // Save flows - now using Supabase
  async function saveFromNewModal(btn){
    const first = $('#naFirst')?.value||'';
    const last  = $('#naLast')?.value||'';
    const email = $('#naEmail')?.value||'';
    const phone = $('#naPhone')?.value||'';
    const vehicle_year = $('#naVehicleYear')?.value||'';
    const vehicle_make = $('#naVehicleMake')?.value||'';
    const vehicle_model = $('#naVehicleModel')?.value||'';
    const vehicle = [vehicle_year, vehicle_make, vehicle_model].filter(v => v).join(' ') || '';
    const vin   = ($('#naVin')?.value||'').trim();

    // Don't save if nothing to identify by
    if(!normPhone(phone) && !normEmail(email) && !first.trim() && !last.trim()) {
      console.log('âš ï¸ No identifying info to save customer');
      return;
    }

    // Save to Supabase
    const result = await saveCustomerToSupabase({
      first_name: first,
      last_name: last,
      phone,
      email,
      vehicle,
      vin,
      notes: ''
    });

    if(result) {
      console.log('âœ… Customer saved to Supabase:', result);
      btn.dataset.sig = sigFromNew();
      setSaved(btn);
    } else {
      console.error('âŒ Failed to save customer');
    }
  }

  async function saveFromEditModal(btn){
    // Always read from modal fields if present
    const customer_first = $('#apptForm [name="customer_first"]')?.value?.trim() || '';
    const customer_last = $('#apptForm [name="customer_last"]')?.value?.trim() || '';
    const phone = $('#apptForm [name="phone"]')?.value?.trim() || '';
    const email = $('#apptForm [name="email"]')?.value?.trim() || '';
    const vehicle_year = $('#apptForm [name="vehicle_year"]')?.value?.trim() || '';
    const vehicle_make = $('#apptForm [name="vehicle_make"]')?.value?.trim() || '';
    const vehicle_model = $('#apptForm [name="vehicle_model"]')?.value?.trim() || '';
    const vehicle = [vehicle_year, vehicle_make, vehicle_model].filter(v => v).join(' ') || '';
    const vin = ($('#apptVin')?.value?.trim() || '');

    // Don't save if nothing to identify by
    if(!normPhone(phone) && !normEmail(email) && !customer_first && !customer_last) {
      console.log('âš ï¸ No identifying info to save customer');
      return;
    }

    // Save to Supabase
    const result = await saveCustomerToSupabase({
      first_name: customer_first,
      last_name: customer_last,
      phone,
      email,
      vehicle,
      vehicle_year,
      vehicle_make,
      vehicle_model,
      vin,
      notes: ''
    });

    if(result) {
      console.log('âœ… Customer saved to Supabase:', result);
      btn.dataset.sig = sigFromEdit();
      setSaved(btn);
    } else {
      console.error('âŒ Failed to save customer');
    }
  }

  // Keep pill sticky until fields change
  function watchInputsFor(btn, inputs, sigFn){
    if(!btn) return;
    const handler = ()=>{
      const currentSig = sigFn();
      const savedSig = btn.dataset.sig || '';
      if(btn.dataset.saved==='1' && currentSig===savedSig){
        setSaved(btn); // ensure it stays locked
      } else {
        setUnsaved(btn); // allow re-save after user changes anything
      }
    };
    inputs.forEach(sel => $$(sel).forEach(el => el.addEventListener('input', handler)));
    // run once on load to set initial state
    handler();
  }

  const btnNew  = $('#saveCustNew');
  const btnEdit = $('#saveCustEdit');

  if(btnNew){
    btnNew.addEventListener('click', ()=> saveFromNewModal(btnNew));
    watchInputsFor(btnNew,
      ['#naFirst','#naLast','#naEmail','#naPhone','#naVehicleYear','#naVehicleMake','#naVehicleModel','#naVin'],
      sigFromNew
    );
  }
  if(btnEdit){
    btnEdit.addEventListener('click', ()=> saveFromEditModal(btnEdit));
    watchInputsFor(btnEdit,
      ['#apptForm [name="customer"]','#apptForm [name="phone"]','#apptForm [name="vehicle"]','#apptVin'],
      sigFromEdit
    );
  }

  // Hide for Staff
  if(isStaff()){ if(btnNew) btnNew.style.display='none'; if(btnEdit) btnEdit.style.display='none'; }

  // Check for #new hash to open modal
  if (window.location.hash === '#new') {
    $('#newApptModal').classList.remove('hidden');
    setTimeout(()=> $('#naFirst').focus(), 50);
  }
})();
</script>


<div id="viewApptModal" class="modal-backdrop hidden" onclick="closeViewApptModal()">
  <div class="modal-card" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h3>Appointment Details</h3>
      <button onclick="closeViewApptModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body" id="viewApptContent">
      <!-- content will be populated -->
    </div>
    <div class="modal-foot">
      <button onclick="closeViewApptModal()" class="btn">Close</button>
  <button id="editFromViewBtn" class="btn info">Edit Appointment</button>
    </div>
  </div>
</div>
<div id="statusModal" class="modal-backdrop hidden" onclick="closeStatusModal()">
  <div class="modal-card" onclick="event.stopPropagation()" style="max-width: 400px;">
    <div class="modal-head">
      <h3>Select Status</h3>
      <button onclick="closeStatusModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <div id="statusPills" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Pills will be populated -->
      </div>
    </div>
  </div>
</div>

<!-- ===== Send Tracking Link Functionality ===== -->
<script>
(function() {
  const $ = (s) => document.querySelector(s);
  
  // Get Supabase client (same one used everywhere)
  const SUPABASE_URL = 'https://hxwufjzyhtwveyxbkkya.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4d3Vmanp5aHR3dmV5eGJra3lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjU0MjAsImV4cCI6MjA3ODMwMTQyMH0.nN7MGoYyqwhonOSPBJlFEZoZrOEAIRP79l43FZK5nh8';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  let currentAppointment = null;
  
  // Show notification
  function showNotification(message, isError = false) {
    const notification = $('#notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.style.background = isError ? '#ef4444' : '#10b981';
    notification.classList.remove('hidden');
    
    setTimeout(() => {
      notification.classList.add('hidden');
    }, 3000);
  }
  
  // Get current shop ID - check multiple sources (same as rest of app)
  function getCurrentShopId() {
    try {
      // First check xm_session in localStorage (this is where auth.js stores it)
      const session = JSON.parse(localStorage.getItem('xm_session') || '{}');
      if (session.shopId) {
        return session.shopId;
      }
      
      // Also check sessionStorage (some parts of app use this)
      const sessionShopId = sessionStorage.getItem('shop_id');
      if (sessionShopId) return sessionShopId;
      
      // Fallback to user's shop_id
      const users = JSON.parse(localStorage.getItem('xm_users') || '[]');
      const currentUser = users.find(u => u.id === session.user_id || u.email === session.email) || session.user || {};
      if (currentUser.shop_id) return currentUser.shop_id;
      
      // Last resort - check xm_shops
      const shops = JSON.parse(localStorage.getItem('xm_shops') || '[]');
      if (shops.length > 0) return shops[0].id;
      
      return null;
    } catch (e) {
      console.error('Error getting shop ID:', e);
      return null;
    }
  }
  
  // Open tracking modal (SMS only)
  function openTrackingModal() {
    const modal = $('#sendTrackingModal');
    const confirmBtn = $('#confirmSendTracking');
    const errorText = $('#trackingModalError');
    
    if (!modal) return;
    
    // Get customer info from form
    const firstName = $('#apptForm [name="customer_first"]')?.value?.trim() || '';
    const lastName = $('#apptForm [name="customer_last"]')?.value?.trim() || '';
    const phone = $('#apptForm [name="phone"]')?.value?.trim() || '';
    
    const customerName = [firstName, lastName].filter(n => n).join(' ') || 'Customer';
    
    // Update modal content
    $('#trackingCustomerName').textContent = customerName;
    $('#trackingCustomerPhone').textContent = phone || 'No phone number';
    
    // Show error if no phone number
    if (!phone) {
      errorText.textContent = 'âš ï¸ No phone number available. Please add a phone number to send the tracker.';
      errorText.style.display = 'block';
      confirmBtn.disabled = true;
    } else {
      errorText.style.display = 'none';
      confirmBtn.disabled = false;
    }
    
    // Store current data
    currentAppointment = {
      firstName,
      lastName,
      phone,
      customerName
    };
    
    modal.classList.remove('hidden');
  }
  
  // Close tracking modal
  function closeTrackingModal() {
    const modal = $('#sendTrackingModal');
    if (modal) {
      modal.classList.add('hidden');
    }
  }
  
  // Send tracking link via SMS - calls the Vercel API (same as invoice sending)
  async function sendTracking() {
    const confirmBtn = $('#confirmSendTracking');
    const errorText = $('#trackingModalError');
    
    if (!currentAppointment.phone) {
      errorText.textContent = 'âš ï¸ No phone number available.';
      errorText.style.display = 'block';
      return;
    }
    
    errorText.style.display = 'none';
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'ðŸ“± Sending...';
    
    try {
      // Get appointment ID from modal
      const appointmentId = window.currentEditingAppointmentId;
      const shopId = getCurrentShopId();
      
      // Also get the tracking code that's being displayed (for debugging)
      const displayedCode = $('#trackingCodeDisplay')?.textContent?.trim();
      console.log('[SendTracking] Displayed tracking code:', displayedCode);
      
      if (!appointmentId) {
        throw new Error('No appointment ID found. Please save the appointment first.');
      }
      
      if (!shopId) {
        throw new Error('No shop ID found. Please refresh the page.');
      }
      
      // Call the Vercel API - use stripe server like invoices do
      // NOTE: You need to copy api/send-tracking.js to your xpose-stripe-server project!
      const API_URL = 'https://xpose-stripe-server.vercel.app';
      
      console.log('[SendTracking] Calling API with:', { appointmentId, shopId, phone: currentAppointment.phone });
      
      const response = await fetch(`${API_URL}/api/send-tracking`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          appointmentId,
          shopId,
          sendEmail: false,
          sendSms: true,
          customerEmail: null,
          customerPhone: currentAppointment.phone,
          customerName: currentAppointment.customerName,
          trackingCode: displayedCode  // Pass the tracking code
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        console.log('âœ… Tracking link sent successfully!');
        console.log('ðŸŽ« Tracking code:', result.shortCode);
        console.log('ðŸ“± Mobile URL:', result.mobileTrackingUrl);
        
        if (result.results?.sms?.success) {
          showNotification('âœ… Tracking link sent via SMS!');
        } else if (result.results?.sms?.error) {
          showNotification(`âš ï¸ SMS issue: ${result.results.sms.error}`, true);
        } else {
          showNotification('âœ… Tracking link sent!');
        }
        closeTrackingModal();
      } else {
        // Handle partial failure
        let errorMsg = 'Failed to send tracking link';
        if (result.results?.sms?.error) {
          errorMsg = result.results.sms.error;
        } else if (result.error) {
          errorMsg = result.error;
        }
        throw new Error(errorMsg);
      }
      
    } catch (error) {
      console.error('Error sending tracking link:', error);
      errorText.textContent = `âŒ ${error.message}`;
      errorText.style.display = 'block';
    } finally {
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'ðŸ“± Send SMS';
    }
  }
  
  // Event listeners
  const sendTrackingBtn = $('#sendTrackingBtn');
  if (sendTrackingBtn) {
    sendTrackingBtn.addEventListener('click', openTrackingModal);
  }
  
  // Copy tracking code button
  const copyTrackingCodeBtn = $('#copyTrackingCodeBtn');
  if (copyTrackingCodeBtn) {
    copyTrackingCodeBtn.addEventListener('click', () => {
      const codeDisplay = $('#trackingCodeDisplay');
      if (codeDisplay && codeDisplay.textContent) {
        navigator.clipboard.writeText(codeDisplay.textContent).then(() => {
          copyTrackingCodeBtn.textContent = 'âœ… Copied!';
          setTimeout(() => {
            copyTrackingCodeBtn.textContent = 'ðŸ“‹ Copy';
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy:', err);
        });
      }
    });
  }
  
  // Also copy when clicking the code itself
  const trackingCodeDisplay = $('#trackingCodeDisplay');
  if (trackingCodeDisplay) {
    trackingCodeDisplay.addEventListener('click', () => {
      if (trackingCodeDisplay.textContent) {
        navigator.clipboard.writeText(trackingCodeDisplay.textContent).then(() => {
          const originalText = trackingCodeDisplay.textContent;
          trackingCodeDisplay.textContent = 'Copied!';
          setTimeout(() => {
            trackingCodeDisplay.textContent = originalText;
          }, 1000);
        });
      }
    });
  }
  
  const closeSendTrackingBtn = $('#closeSendTrackingModal');
  if (closeSendTrackingBtn) {
    closeSendTrackingBtn.addEventListener('click', closeTrackingModal);
  }
  
  const confirmSendTrackingBtn = $('#confirmSendTracking');
  if (confirmSendTrackingBtn) {
    confirmSendTrackingBtn.addEventListener('click', sendTracking);
  }
  
  // Close modal on backdrop click
  const trackingModal = $('#sendTrackingModal');
  if (trackingModal) {
    trackingModal.addEventListener('click', (e) => {
      if (e.target === trackingModal) {
        closeTrackingModal();
      }
    });
  }
})();
</script>

</body>
</html>
