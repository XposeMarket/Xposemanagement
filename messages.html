<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Messages</title><link rel="stylesheet" href="styles.css"></head><body>
<header class="top">
  <div class="container row top row">
    <a class="brand" href="dashboard.html" aria-label="Home">
      <img id="headerLogo" src="assets/XposeManagementCRMlogo.png" alt="Logo">
    </a>
    <button id="menuToggle" class="menu-toggle" aria-label="Toggle menu"><span></span><span></span><span></span></button><nav id="mainNav">
      <a href="dashboard.html" class="">Dashboard</a>
      <a href="appointments.html" class="">Appointments</a>
      <a href="jobs.html" class="">Jobs</a>
      <a href="messages.html" class="active">Messages</a>
      <a href="invoices.html" class="">Invoices</a>
      <a href="customers.html" class="">Customers</a>
      <a href="revenue.html" class="">Revenue</a>
      <a href="inventory.html" class="" id="inventoryNavLink" style="display:none">Inventory</a>
      <a href="settings.html" class="">Settings</a>
      <a href="profile.html" class="">Profile</a>
        <a href="#" id="mobileThemeToggle" class="mobile-nav-btn mobile-special">Theme</a>
        <a href="#" id="mobileLogoutBtn" class="mobile-nav-btn mobile-special">Logout</a>
    </nav>
    <div>
      <button id="themeToggle" class="btn" aria-label="Toggle theme">Theme</button>
      <button id="logoutBtn" class="btn" aria-label="Logout">Logout</button>
    </div>
    <!-- Customer Modal (reuse same inputs as Customers page) -->
    <div id="custModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="custModalTitle">
      <div class="modal-card">
        <div class="modal-head">
          <h3 id="custModalTitle" style="margin:0">Customer</h3>
          <button class="btn" id="custModalClose">Close</button>
        </div>
        <div class="modal-body">
          <div class="grid cols-2">
            <div><label>First</label><input id="newCustFirst" placeholder="First name"></div>
            <div><label>Last</label><input id="newCustLast" placeholder="Last name"></div>
          </div>
          <label>Phone</label><input id="newCustPhone" placeholder="(555) 555-0123">
          <label>Email</label><input id="newCustEmail" placeholder="name@example.com">
          <div style="margin-top:8px">
            <label>Notes</label>
            <textarea id="newCustNotes" rows="3" placeholder="Optional notes"></textarea>
          </div>
          <!-- Vehicle section (hidden until requested) -->
          <div id="custVehicleSection" class="hidden" style="margin-top:12px;border-top:1px dashed var(--line);padding-top:12px">
            <div class="grid cols-3">
              <div><label>Year</label><input id="custVehYear" placeholder="Year"></div>
              <div><label>Make</label><input id="custVehMake" placeholder="Make"></div>
              <div><label>Model</label><input id="custVehModel" placeholder="Model"></div>
            </div>
            <label>VIN</label><input id="custVehVin" placeholder="VIN">
          </div>
        </div>
        <div class="modal-foot">
          <button class="btn" id="newCustCancel">Cancel</button>
          <button class="btn" id="newCustSave">Save</button>
          <button class="btn" id="newCustSaveAddVeh">Save + Add Vehicle</button>
          <button class="btn" id="newCustNewAppt">New Appointment</button>
        </div>
      </div>
    </div>

    <!-- Ask to Add Vehicle Modal -->
    <div id="askAddVehicleModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="askAddVehicleTitle">
      <div class="modal-card" style="max-width:420px">
        <div class="modal-head">
          <h3 id="askAddVehicleTitle" style="margin:0">Add vehicle?</h3>
          <button class="btn" id="askAddVehicleClose">Close</button>
        </div>
        <div class="modal-body">
          <p class="muted">Would you like to add a vehicle for this customer now?</p>
        </div>
        <div class="modal-foot">
          <button class="btn" id="askAddVehicleNo">No, skip</button>
          <button class="btn" id="askAddVehicleYes">Yes, add vehicle</button>
        </div>
      </div>
    </div>

    <!-- New Thread Modal -->
    <div id="newThreadModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="newThreadTitle">
      <div class="modal-card" style="max-width:420px">
        <div class="modal-head">
          <h3 id="newThreadTitle" style="margin:0">Start a Conversation</h3>
          <button class="btn" id="newThreadClose">Close</button>
        </div>
        <div class="modal-body">
          <label>Customer Phone Number</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="newThreadPhone" placeholder="+1 (555) 555-0123" style="flex:1;padding:10px 12px;border-radius:8px;border:1px solid var(--line);outline:none;" />
            <button id="newThreadSave" class="btn primary" style="flex:0 0 auto;border-radius:8px;padding:10px 14px;">+</button>
          </div>
          <p style="font-size:12px;color:var(--muted);margin-top:8px;">Enter a customer's phone number to start messaging them.</p>
        </div>
      </div>
    </div>
  </div>
</header>
<main class="container" style="padding:16px 0">
  <h1>Messages</h1>
  <div class="messages-wrap" style="position:relative; display:flex; gap:16px;">
    <aside class="card threads-panel" style="width:320px;flex:0 0 320px;display:flex;flex-direction:column;">
      <div id="threadPanelHeader" style="padding:12px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-direction:column;align-items:stretch;">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;width:100%">
          <strong>Messages</strong>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="newThreadBtn" class="btn small">New</button>
            <button id="editThreadsBtn" class="btn small">Edit</button>
          </div>
        </div>
        <input id="threadSearch" placeholder="Search customers or threads" style="margin-top:8px;padding:8px 10px;border-radius:8px;border:1px solid var(--line);width:100%" />
      </div>
      <div id="threadList" style="overflow:auto;flex:1;padding:8px;"></div>
    </aside>

    <section class="card chat-panel" style="flex:1;display:flex;flex-direction:column;">
      <div id="threadHeader" style="padding:12px 16px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:12px;">
        <button id="threadBackBtn" class="btn small mobile-only hidden" aria-label="Back">Back</button>
        <div id="threadAvatar" style="width:44px;height:44px;border-radius:8px;background:#e9eef8;flex:0 0 44px"></div>
        <div style="flex:1;min-width:0;text-align:left;">
          <div id="threadTitle">Select a thread</div>
          <div id="threadSubtitle" style="font-size:12px;color:var(--muted)"></div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div id="threadCenteredTitle" class="mobile-only hidden" style="position:absolute;left:0;right:0;text-align:center;pointer-events:none;"></div>
          <button id="threadInfoBtn" class="btn small" aria-label="Info">Info</button>
        </div>
      </div>

      <div id="chatBox" style="flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg, var(--card), #f7fbff);">
        <!-- messages appended here -->
      </div>

      <form id="sendForm" style="display:flex;gap:8px;padding:12px;border-top:1px solid var(--line);align-items:center;">
        <input id="msgInput" placeholder="iMessage-style: Type a message" style="flex:1;padding:10px 12px;border-radius:20px;border:1px solid var(--line);outline:none;" />
        <button id="sendBtn" class="btn primary" type="submit">Send</button>
      </form>
    </section>
  </div>
</main>

<style>
  /* Messages page: bubble styles (iMessage-inspired) */
  .thread-item:hover{ background:rgba(0,0,0,0.03); }
  .msg-row { width:100%; display:flex; }
  .bubble { max-width:72%; padding:10px 12px;border-radius:18px;position:relative;font-size:14px;line-height:1.3 }
  .bubble.incoming { background:#f1f3f5;color:var(--text); border-top-left-radius:6px; }
  .bubble.outgoing { background:linear-gradient(180deg,#3b82f6,#2563eb); color:white; border-top-right-radius:6px; }
  .bubble-time { display:block;font-size:11px;color:rgba(0,0,0,0.45);margin-top:6px;text-align:right;opacity:0.85 }
  .bubble.outgoing .bubble-time{ color: rgba(255,255,255,0.82); }
  .threads-panel { padding:0; }
  .threads-panel .thread-item + .thread-item { margin-top:6px; }
  .chat-panel { display:flex; flex-direction:column; }
  /* composer focus */
  #msgInput:focus{ box-shadow:0 0 0 3px rgba(59,130,246,0.08); border-color:rgba(59,130,246,0.6); }
  @media (max-width:900px){
    /* Mobile: both threads and chat are full-screen, slide between them */
    .threads-panel{ position:fixed; inset:56px 0 0 0; background:var(--card); z-index:80; width:100%; display:block; transform:translateX(0%); transition:transform .22s ease; overflow:hidden; }
    .threads-panel.mobile-hidden{ transform:translateX(-100%); }
    .chat-panel{ position:fixed; inset:56px 0 0 0; background:var(--card); z-index:80; width:100%; transform:translateX(100%); transition:transform .22s ease; }
    .chat-panel.mobile-open{ transform:translateX(0%); }
    .mobile-only{ display:inline-flex; }
    .desktop-only{ display:none; }
    .messages-wrap { height:auto; flex-direction:column; gap:0; position:fixed; inset:56px 0 0 0; width:100%; overflow:hidden; }
    #threadList { max-height: 100%; width:100%; overflow-y:auto; padding:8px; box-sizing:border-box; }
    #chatBox { padding:12px; }
    /* Hide inline header title on mobile and use centered title instead */
    #threadTitle, #threadSubtitle { display:none; }
    #threadCenteredTitle { display:block; position:absolute; left:56px; right:56px; text-align:center; pointer-events:none; z-index:0; }
    #threadBackBtn { z-index:2; }
    /* Info button stays on top of messages */
    #threadInfoBtn { position:fixed; top:56px; right:12px; z-index:95; }
  }
  /* Modal styles (shared with other pages) */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:90; }
    /* Ensure modals always appear on top of transformed/chat panels */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center; z-index:99999; }
  .modal-card { width:min(520px,92vw); background:var(--card,#fff); color:inherit; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .modal-head { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--line,#e5e5e5); }
  .modal-body { padding:12px 14px; }
  .modal-foot { display:flex; justify-content:flex-end; gap:8px; padding:12px 14px; border-top:1px solid var(--line,#e5e5e5); }
  .hidden { display:none; }

  /* Threads panel sizing: show up to 6 items height by default and keep chat constrained */
  /* Height sized to show 5 thread rows by default (5 * 64px + 4 * 6px gap = 344px) */
  .messages-wrap { position:relative; display:flex; gap:16px; min-height:344px; align-items:stretch; }
  .threads-panel { padding:0; display:flex; flex-direction:column; width:320px; flex:0 0 320px; }
  #threadList { overflow:auto; flex:1; padding:8px; max-height:344px; }
  .thread-item { height:64px; }
  .chat-panel { display:flex; flex-direction:column; min-height:0; flex:1; }
  #chatBox { flex:1; overflow:auto; min-height:0; }
  /* Mobile thread-item layout fix: use grid for avatar, name, last message */
  @media (max-width:900px){
    .thread-item {
      display: grid !important;
      grid-template-columns: 44px 1fr;
      grid-template-rows: auto auto;
      align-items: center;
      gap: 0 12px;
      padding: 10px 12px;
      border-radius: 8px;
      min-width: 0;
      height: 64px;
    }
    .thread-item > div:first-child {
      grid-row: 1 / span 2;
      grid-column: 1;
      width: 44px;
      height: 44px;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .thread-item > div:nth-child(2) {
      grid-row: 1;
      grid-column: 2;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }
    .thread-item > div:nth-child(3) {
      grid-row: 2;
      grid-column: 2;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      margin: 0;
    }
  }
  /* Mobile thread-item layout fix */
  @media (max-width:900px){
    .thread-item {
      display: flex !important;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 8px;
      min-width: 0;
    }
    .thread-item > div:first-child {
      flex: 0 0 44px;
      margin-right: 8px;
    }
    .thread-item > div:nth-child(2) {
      flex: 1 1 auto;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .thread-item > div:nth-child(3) {
      flex: 0 0 auto;
      margin-left: 8px;
    }
  }
</style>

<footer class="container">Â© Xpose Market</footer>

<!-- Remove Thread Confirmation Modal -->
<div id="removeThreadModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="removeThreadTitle">
  <div class="modal-card" style="max-width:400px">
    <div class="modal-head">
      <h3 id="removeThreadTitle" style="margin:0">Remove Message Thread</h3>
      <button class="btn" id="removeThreadClose">Close</button>
    </div>
    <div class="modal-body">
      <p id="removeThreadMsg" class="muted">Are you sure you want to remove this message thread? This cannot be undone.</p>
    </div>
    <div class="modal-foot">
      <button class="btn" id="removeThreadCancel">Cancel</button>
      <button class="btn danger" id="removeThreadConfirm">Remove</button>
    </div>
  </div>
</div>
<script src="vendor/supabase.umd.js"></script>
<script type="module" src="app.js"></script>
<script src="multi-tenant.js"></script>
</body></html>