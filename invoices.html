<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Invoices</title><link rel="stylesheet" href="styles.css"><link rel="stylesheet" href="css/terminal-modal.css">
<style>
  .modal-backdrop { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:10030; }
  .modal-card { width:min(720px,92vw); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  .modal-head { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border,#e5e5e5); }
  .modal-body { padding:12px 14px; }
  .modal-foot { display:flex; justify-content:flex-end; gap:8px; padding:12px 14px; border-top:1px solid var(--border,#e5e5e5); }
  .hidden { display:none; }
  .notification { position:fixed; top:20px; right:20px; padding:12px 20px; border-radius:8px; color:#fff; font-weight:500; z-index:1000; transition:opacity 0.3s; }
  .notification.hidden { opacity:0; pointer-events:none; }
</style>
</head><body>
<!-- Toast notification -->
<div id="notification" class="notification hidden"></div>

<header class="top">
  <div class="container row top row">
    <a class="brand" href="dashboard.html" aria-label="Home">
      <img id="headerLogo" src="assets/XposeManagementCRMlogo.png" alt="Logo">
    </a>
    <button id="menuToggle" class="menu-toggle" aria-label="Toggle menu"><span></span><span></span><span></span></button><nav id="mainNav">
      <a href="dashboard.html" class="">Dashboard</a>
      <a href="appointments.html" class="">Appointments</a>
      <a href="jobs.html" class="">Jobs</a>
      <a href="messages.html" class="">Messages</a>
      <a href="invoices.html" class="active">Invoices</a>
      <a href="customers.html" class="">Customers</a>
      <a href="revenue.html" class="">Revenue</a>
      <a href="inventory.html" class="" id="inventoryNavLink" style="display:none">Inventory</a>
      <a href="settings.html" class="">Settings</a>
      <a href="profile.html" class="">Profile</a>
      <a href="#" id="mobileThemeToggle" class="mobile-nav-btn mobile-special">Theme</a>
      <a href="#" id="mobileLogoutBtn" class="mobile-nav-btn mobile-special">Logout</a>
    </nav>
    <div>
      <button id="themeToggle" class="btn" aria-label="Toggle theme">Theme</button>
      <button id="logoutBtn" class="btn" aria-label="Logout">Logout</button>
    </div>
  </div>
</header>
<main class="container" style="padding:16px 0"><h1>Invoices</h1>
  <div class="card">
    <div class="toolbar">
      <button id="newInvoice" class="btn primary">New Invoice</button>
      <input id="invSearch" placeholder="Search open‚Ä¶">
    </div>
    <table class="table" id="invTable">
      <thead>
        <tr>
          <th class="sortable" data-col="number">#</th>
          <th class="sortable" data-col="customer">Customer</th>
          <th class="sortable" data-col="total">Total</th>
          <th class="sortable" data-col="status">Status</th>
          <th class="sortable" data-col="due">Due</th>
          <th style="padding:0; min-width:120px;">
            <div style="display:inline-grid; justify-items:center; width:100%; margin-left:24px;">
              Actions
            </div>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="notice" id="invEmpty"></p>
  </div>

  <details id="prevWrap" class="card" style="margin-top:14px">
    <summary><b>Previous Invoices (Paid)</b></summary>
    <div class="toolbar"><input id="prevSearch" placeholder="Search paid‚Ä¶"></div>
    <table class="table" id="prevTable">
      <thead>
        <tr>
          <th class="sortable" data-col="number">#</th>
          <th class="sortable" data-col="customer">Customer</th>
          <th class="sortable" data-col="total">Total</th>
          <th class="sortable" data-col="status">Status</th>
          <th class="sortable" data-col="due">Due</th>
          <th style="padding:0; min-width:120px;">
            <div style="display:inline-grid; justify-items:center; width:100%; margin-left:24px;">
              Actions
            </div>
          </th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="notice" id="prevEmpty"></p>
  </details>
<div id="invModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="invTitle">
  <div class="modal-card">
    <div class="modal-head">
      <div style="display:flex;flex-direction:column;gap:6px;">
        <h2 id="invTitle">New Invoice</h2>
        <div id="platformFeeDesc" style="font-size:0.85rem;color:var(--muted);">Platform fee: Stripe processing (2.7% + $0.05) + Xpose platform fee (2.3%)</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button id="sendEstimateBtn" class="btn quick-create" style="display:flex;align-items:center;gap:6px;" title="Send estimate to customer for approval">
          <span style="font-size:1.1em;">üìã</span>
          <span style="font-weight:600;">Send Estimate</span>
        </button>
        <button id="closeInv" class="btn">Close</button>
      </div>
    </div>
    <div class="modal-body" style="max-height:60vh; overflow-y:auto">
      <div class="grid cols-2" style="margin-top:8px">
        <div><label>First Name</label><input id="invCustomerFirst" placeholder="First name" /></div>
        <div><label>Last Name</label><input id="invCustomerLast" placeholder="Last name" /></div>
        <div><label>Appointment ID (optional)</label><input id="invAppt" placeholder="a123..." /></div>
        <div><label>Tax %</label><input id="invTax" type="number" value="6" /></div>
        <div><label>Discount %</label><input id="invDisc" type="number" value="0" /></div>
        <div><label>Due</label><input id="invDue" type="date" /></div>
      </div>
      <div style="margin-top:10px; position:relative">
          <div class="toolbar" style="justify-content:space-between">
            <h3>Items</h3>
            <div>
              <button id="addPart" class="btn">Add Parts</button>
              <button id="addLabor" class="btn">Add Labor</button>
              <button id="addService" class="btn">Add Service</button>
            </div>
          </div>
          <div id="items"></div>
          <!-- Floating centered + button (large, tappable) -->
          <div style="text-align:center; padding:10px 0 36px 0">
            <button id="floatingAdd" class="btn" aria-label="Add item">+</button>
          </div>
        </div>
    </div>
    <div class="modal-foot" style="align-items:center;">
      <div style="margin-right:auto;"></div>
      <div>Subtotal: $<span id="subTotal">0.00</span></div><div style="width:14px"></div>
      <div>Grand Total: $<span id="grandTotal">0.00</span></div><div style="width:14px"></div>
      <div>Total After Platform Fee: $<span id="netTotal">0.00</span></div><div style="width:14px"></div>
      <button id="saveInv" class="btn primary">Save</button>
    </div>
  </div>
</div>

<!-- Item Type Selection Modal -->
<div id="itemTypeModal" class="modal-backdrop hidden">
  <div class="modal-card" style="max-width:400px">
    <div class="modal-head">
      <h3>Add Item Type</h3>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:20px">Select the type of item to add:</p>
      <div style="display:flex;gap:10px;justify-content:center">
        <button id="addPartBtn" class="btn primary">Part</button>
        <button id="addLaborBtn" class="btn primary">Labor</button>
        <button id="addServiceBtn" class="btn primary">Service</button>
        <button id="cancelItemBtn" class="btn">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirm Item Remove Modal (modal-themed confirmation for removing an item) -->
<div id="confirmItemRemoveModal" class="modal-backdrop hidden" onclick="closeConfirmItemRemoveModal()">
  <div class="modal-card" onclick="event.stopPropagation()" style="max-width:380px">
    <div class="modal-head">
      <h3>Remove Item</h3>
      <button onclick="closeConfirmItemRemoveModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="confirmItemRemoveMessage">Are you sure you want to remove this item?</p>
    </div>
    <div class="modal-foot">
      <button id="confirmItemRemoveCancel" class="btn">Cancel</button>
      <button id="confirmItemRemoveConfirm" class="btn danger">Remove</button>
    </div>
  </div>
</div>

<!-- Confirm Mark Paid Modal -->
<div id="removeInvModal" class="modal-backdrop hidden" onclick="closeRemoveInvModal()">
  <div class="modal-card" onclick="event.stopPropagation()" style="max-width: 400px;">
    <div class="modal-head">
      <h3>Remove Invoice</h3>
      <button onclick="closeRemoveInvModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <p>Are you sure you want to remove this invoice?</p>
      <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
        <button id="removeInvBtn" class="btn danger" style="width: 100%;">Remove Invoice</button>
        <button id="removeInvApptBtn" class="btn danger" style="width: 100%;">Remove Invoice & Appointment</button>
        <button id="cancelRemoveInvBtn" class="btn" style="width: 100%;">Cancel</button>
      </div>
    </div>
  </div>
</div>

</main>

<!-- Confirm Mark Paid/Unpaid Modal -->
<div id="confirmPayModal" class="modal-backdrop hidden" onclick="closeConfirmPayModal()">
  <div class="modal-card" onclick="event.stopPropagation()" style="max-width:420px">
    <div class="modal-head">
      <h3 id="confirmPayTitle">Confirm</h3>
      <button onclick="closeConfirmPayModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <p id="confirmPayMessage">Are you sure you want to proceed?</p>
    </div>
    <div class="modal-foot">
      <button id="confirmPayCancel" class="btn">Cancel</button>
      <button id="confirmPayConfirm" class="btn info">Confirm</button>
    </div>
  </div>
</div>

<!-- Send Invoice Modal -->
<div id="sendInvoiceModal" class="modal-backdrop hidden" onclick="closeSendInvoiceModal()">
  <div class="modal-card" onclick="event.stopPropagation()" style="max-width:480px">
    <div class="modal-head">
      <h3>üì§ Send Invoice</h3>
      <button onclick="closeSendInvoiceModal()" class="btn-close">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin-bottom:16px;color:var(--muted);">Send invoice #<span id="sendInvNumber"></span> to the customer:</p>
      
      <div style="margin-bottom:16px;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--line);">
          <input type="checkbox" id="sendEmailCheckbox" checked style="width:20px;height:20px;">
          <div>
            <strong>üìß Email Invoice</strong>
            <div id="sendEmailAddress" style="font-size:0.875rem;color:var(--muted);"></div>
          </div>
        </label>
      </div>
      
      <div style="margin-bottom:16px;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--line);">
          <input type="checkbox" id="sendSmsCheckbox" checked style="width:20px;height:20px;">
          <div>
            <strong>üì± Text Invoice</strong>
            <div id="sendSmsPhone" style="font-size:0.875rem;color:var(--muted);"></div>
          </div>
        </label>
      </div>

      <div id="sendInvoiceNoContact" style="display:none;padding:12px;background:#fef3c7;border-radius:8px;color:#92400e;margin-bottom:16px;">
        <strong>‚ö†Ô∏è No contact info found</strong>
        <p style="margin:8px 0 0;font-size:0.875rem;">Add customer email or phone to send invoice.</p>
      </div>

      <div id="sendInvoiceStatus" style="display:none;padding:12px;border-radius:8px;margin-bottom:16px;"></div>
    </div>
    <div class="modal-foot">
      <button id="sendInvSkip" class="btn" onclick="closeSendInvoiceModal()">Skip</button>
      <button id="sendInvBtn" class="btn primary">Send Invoice</button>
    </div>
  </div>
</div>

<footer class="container">¬© Xpose Market</footer>
<script src="vendor/supabase.umd.js"></script>
<script src="components/partPricingModal.js"></script>
<script type="module" src="app.js"></script>
<script src="multi-tenant.js"></script>
<script>
  // Check for #new hash to open modal
  if (window.location.hash === '#new') {
    document.getElementById('invModal').classList.remove('hidden');
    setTimeout(() => document.getElementById('invCustomer').focus(), 50);
  }
</script>
<!-- Defensive fallback: make sure Close button always hides modal -->
<script>
  (function(){
    const closeBtn = document.getElementById('closeInv');
    const modal = document.getElementById('invModal');
    if (closeBtn && modal) {
      closeBtn.addEventListener('click', () => modal.classList.add('hidden'));
    }
  })();
</script>

<!-- Send Invoice Modal Functions -->
<script>
  // Close Send Invoice Modal
  window.closeSendInvoiceModal = function() {
    const modal = document.getElementById('sendInvoiceModal');
    if (modal) modal.classList.add('hidden');
  };

  // Show Send Invoice Modal - ALWAYS fetches FRESH customer data from Supabase
  // Priority: 1) appointments table (source of truth) 2) jobs table 3) customers table (saved repeat customers only)
  window.showSendInvoiceModal = async function(inv) {
    console.log('[SendInvoice] showSendInvoiceModal called with invoice:', inv?.id);
    const modal = document.getElementById('sendInvoiceModal');
    if (!modal || !inv) {
      console.warn('[SendInvoice] Modal or invoice missing - modal:', !!modal, 'inv:', !!inv);
      return;
    }

    // ALWAYS fetch fresh customer data - prioritize appointments table (source of truth)
    let customerEmail = '';
    let customerPhone = '';
    let customerName = '';

    // Build customer name from invoice if available
    if (inv.customer_first || inv.customer_last) {
      customerName = `${inv.customer_first || ''} ${inv.customer_last || ''}`.trim();
    }

    const supabase = window._supabaseClient;
    
    // PRIORITY 1: Fetch from appointments table (PRIMARY source of truth for contact info)
    // The appointments table stores customer contact info directly on each appointment
    if (supabase && inv.appointment_id) {
      try {
        console.log('[SendInvoice] Fetching FRESH contact from appointments table for appointment_id:', inv.appointment_id);
        const { data: appt, error } = await supabase
          .from('appointments')
          .select('email, phone, customer_first, customer_last')
          .eq('id', inv.appointment_id)
          .single();
        
        if (!error && appt) {
          customerEmail = appt.email || '';
          customerPhone = appt.phone || '';
          if (!customerName && (appt.customer_first || appt.customer_last)) {
            customerName = `${appt.customer_first || ''} ${appt.customer_last || ''}`.trim();
          }
          console.log('[SendInvoice] Got contact from appointments table - email:', customerEmail, 'phone:', customerPhone, 'name:', customerName);
        } else if (error) {
          console.warn('[SendInvoice] Error fetching appointment:', error);
        }
      } catch (e) {
        console.warn('[SendInvoice] Could not fetch from appointments table:', e);
      }
    }
    
    // PRIORITY 2: Fallback to jobs table if appointment lookup failed or incomplete
    if (supabase && inv.job_id && (!customerEmail || !customerPhone)) {
      try {
        console.log('[SendInvoice] Fallback: Fetching from jobs table for job_id:', inv.job_id);
        const { data: job, error } = await supabase
          .from('jobs')
          .select('email, phone, customer_first, customer_last')
          .eq('id', inv.job_id)
          .single();
        
        if (!error && job) {
          if (!customerEmail && job.email) customerEmail = job.email;
          if (!customerPhone && job.phone) customerPhone = job.phone;
          if (!customerName && (job.customer_first || job.customer_last)) {
            customerName = `${job.customer_first || ''} ${job.customer_last || ''}`.trim();
          }
          console.log('[SendInvoice] Got contact from jobs table - email:', customerEmail, 'phone:', customerPhone);
        }
      } catch (e) {
        console.warn('[SendInvoice] Could not fetch from jobs table:', e);
      }
    }
    
    // PRIORITY 3: Last resort fallback to customers table (only for saved repeat customers)
    // Note: customers table is ONLY populated when user explicitly clicks "Save Customer"
    if (supabase && inv.customer_id && (!customerEmail || !customerPhone)) {
      try {
        console.log('[SendInvoice] Last resort: Fetching from customers table for customer_id:', inv.customer_id);
        const { data: customer, error } = await supabase
          .from('customers')
          .select('email, phone, customer_first, customer_last')
          .eq('id', inv.customer_id)
          .single();
        
        if (!error && customer) {
          if (!customerEmail) customerEmail = customer.email || '';
          if (!customerPhone) customerPhone = customer.phone || '';
          if (!customerName && (customer.customer_first || customer.customer_last)) {
            customerName = `${customer.customer_first || ''} ${customer.customer_last || ''}`.trim();
          }
          console.log('[SendInvoice] Got contact from customers table - email:', customerEmail, 'phone:', customerPhone);
        }
      } catch (e) {
        console.warn('[SendInvoice] Could not fetch from customers table:', e);
      }
    }

    console.log('[SendInvoice] Final customer contact info - email:', customerEmail, 'phone:', customerPhone, 'name:', customerName);

    // Update UI elements
    const emailCheckbox = document.getElementById('sendEmailCheckbox');
    const smsCheckbox = document.getElementById('sendSmsCheckbox');
    const emailAddressEl = document.getElementById('sendEmailAddress');
    const smsPhoneEl = document.getElementById('sendSmsPhone');
    const noContactEl = document.getElementById('sendInvoiceNoContact');
    const statusEl = document.getElementById('sendInvoiceStatus');
    const sendBtnModal = document.getElementById('sendInvBtn');

    // Reset status
    if (statusEl) {
      statusEl.style.display = 'none';
      statusEl.innerHTML = '';
    }

    // Email option
    if (customerEmail) {
      if (emailCheckbox) emailCheckbox.disabled = false;
      if (emailCheckbox) emailCheckbox.checked = true;
      if (emailAddressEl) emailAddressEl.textContent = customerEmail;
    } else {
      if (emailCheckbox) emailCheckbox.disabled = true;
      if (emailCheckbox) emailCheckbox.checked = false;
      if (emailAddressEl) emailAddressEl.textContent = 'No email on file';
    }

    // SMS option
    if (customerPhone) {
      if (smsCheckbox) smsCheckbox.disabled = false;
      if (smsCheckbox) smsCheckbox.checked = true;
      if (smsPhoneEl) smsPhoneEl.textContent = customerPhone;
    } else {
      if (smsCheckbox) smsCheckbox.disabled = true;
      if (smsCheckbox) smsCheckbox.checked = false;
      if (smsPhoneEl) smsPhoneEl.textContent = 'No phone on file';
    }

    // Show warning if no contact info
    if (!customerEmail && !customerPhone) {
      if (noContactEl) noContactEl.style.display = 'block';
      if (sendBtnModal) sendBtnModal.disabled = true;
    } else {
      if (noContactEl) noContactEl.style.display = 'none';
      if (sendBtnModal) sendBtnModal.disabled = false;
    }

    // Store data on modal for sending
    modal.dataset.invoiceId = inv.id;
    modal.dataset.shopId = inv.shop_id || (JSON.parse(localStorage.getItem('xm_session') || '{}').shopId || '');
    modal.dataset.email = customerEmail;
    modal.dataset.phone = customerPhone;
    modal.dataset.customerName = customerName;

    // Set invoice number in modal
    const invNumberEl = document.getElementById('sendInvNumber');
    if (invNumberEl) {
      invNumberEl.textContent = inv.number || inv.id.slice(0, 8);
    }

    // Detect estimate vs invoice and update modal labels
    const isEstimate = (inv.status || '').toString().trim().toLowerCase() === 'open estimate';
    const headH3 = modal.querySelector('.modal-head h3');
    const bodyP = modal.querySelector('.modal-body p');
    if (isEstimate) {
      if (headH3) headH3.textContent = 'üì§ Send Estimate';
      if (bodyP) bodyP.textContent = `Send estimate #${inv.number || inv.id} to the customer:`;
      if (sendBtnModal) sendBtnModal.textContent = 'Send Estimate';
      modal.dataset.estimate = '1';
    } else {
      if (headH3) headH3.textContent = 'üì§ Send Invoice';
      if (bodyP) bodyP.textContent = `Send invoice #${inv.number || inv.id} to the customer:`;
      if (sendBtnModal) sendBtnModal.textContent = 'Send Invoice';
      modal.dataset.estimate = '';
    }

    // Wire up send button
    if (sendBtnModal) {
      sendBtnModal.onclick = () => sendInvoiceFromModal();
    }

    // Show modal
    modal.classList.remove('hidden');
  };

  // Send invoice from the modal
  async function sendInvoiceFromModal() {
    console.log('[SendInvoice] sendInvoiceFromModal called');
    const modal = document.getElementById('sendInvoiceModal');
    const sendBtnModal = document.getElementById('sendInvBtn');
    const statusEl = document.getElementById('sendInvoiceStatus');
    const emailCheckbox = document.getElementById('sendEmailCheckbox');
    const smsCheckbox = document.getElementById('sendSmsCheckbox');

    const sendEmail = emailCheckbox?.checked && !emailCheckbox?.disabled;
    const sendSms = smsCheckbox?.checked && !smsCheckbox?.disabled;

    console.log('[SendInvoice] sendEmail:', sendEmail, 'sendSms:', sendSms);

    if (!sendEmail && !sendSms) {
      console.warn('[SendInvoice] No delivery method selected');
      if (statusEl) {
        statusEl.style.display = 'block';
        statusEl.style.background = '#fef3c7';
        statusEl.style.color = '#92400e';
        statusEl.innerHTML = 'Please select at least one delivery method.';
      }
      return;
    }

    // Show loading state
    if (sendBtnModal) {
      sendBtnModal.disabled = true;
      sendBtnModal.textContent = 'Sending...';
    }
    if (statusEl) {
      statusEl.style.display = 'block';
      statusEl.style.background = '#e0f2fe';
      statusEl.style.color = '#0369a1';
      statusEl.innerHTML = '‚è≥ Sending invoice...';
    }

    try {
      const API_URL = 'https://xpose-stripe-server.vercel.app';
      
      console.log('[SendInvoice] Sending to API:', API_URL, {
        invoiceId: modal.dataset.invoiceId,
        shopId: modal.dataset.shopId,
        sendEmail,
        sendSms,
        customerEmail: modal.dataset.email,
        customerPhone: modal.dataset.phone,
        estimate: modal.dataset.estimate === '1'
      });

      const response = await fetch(`${API_URL}/api/send-invoice`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          invoiceId: modal.dataset.invoiceId,
          shopId: modal.dataset.shopId,
          sendEmail,
          sendSms,
          customerEmail: modal.dataset.email || null,
          customerPhone: modal.dataset.phone || null,
          customerName: modal.dataset.customerName || 'Customer',
          estimate: modal.dataset.estimate === '1'
        })
      });

      console.log('[SendInvoice] API response status:', response.status);
      const result = await response.json();
      console.log('[SendInvoice] API result:', result);

      if (result.success) {
        if (statusEl) {
          statusEl.style.background = '#d1fae5';
          statusEl.style.color = '#065f46';
          let msg = '‚úÖ Invoice sent successfully!';
          if (result.results?.email?.success && result.results?.sms?.success) {
            msg = '‚úÖ Invoice sent via email and SMS!';
          } else if (result.results?.email?.success) {
            msg = '‚úÖ Invoice sent via email!';
          } else if (result.results?.sms?.success) {
            msg = '‚úÖ Invoice sent via SMS!';
          }
          statusEl.innerHTML = msg;
        }
        // Auto-close after success
        setTimeout(() => {
          closeSendInvoiceModal();
        }, 2500);
      } else {
        if (statusEl) {
          statusEl.style.background = '#fef3c7';
          statusEl.style.color = '#92400e';
          let msg = '‚ö†Ô∏è ';
          if (result.results?.email && !result.results.email.success) {
            msg += `Email failed: ${result.results.email.error}. `;
          }
          if (result.results?.sms && !result.results.sms.success) {
            msg += `SMS failed: ${result.results.sms.error}. `;
          }
          statusEl.innerHTML = msg || 'Failed to send invoice.';
        }
      }
    } catch (error) {
      console.error('[SendInvoice] Error:', error);
      if (statusEl) {
        statusEl.style.background = '#fee2e2';
        statusEl.style.color = '#991b1b';
        statusEl.innerHTML = `‚ùå Error: ${error.message || 'Failed to send invoice'}`;
      }
    } finally {
      if (sendBtnModal) {
        sendBtnModal.disabled = false;
        const isEst = modal?.dataset?.estimate === '1';
        sendBtnModal.textContent = isEst ? 'Send Estimate' : 'Send Invoice';
      }
    }
  }
</script>
</body></html>