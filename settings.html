<script>
// Show notification helper (success/error)
function showNotification(message, type = 'success') {
  const shopSaved = document.getElementById('shopSaved');
  if (!shopSaved) return;
  shopSaved.textContent = message;
  shopSaved.className = 'notice ' + (type === 'error' ? 'danger' : 'success');
  setTimeout(() => {
    shopSaved.textContent = '';
    shopSaved.className = 'notice';
  }, 3000);
}
</script>
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Settings</title><link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="/css/terminal-settings-styles.css">
</head><body>
<header class="top">
  <div class="container row top row">
    <a class="brand" href="dashboard.html" aria-label="Home">
      <img id="headerLogo" src="assets/XposeManagementCRMlogo.png" alt="Logo">
    </a>
    <button id="menuToggle" class="menu-toggle" aria-label="Toggle menu"><span></span><span></span><span></span></button><nav id="mainNav">
      <a href="dashboard.html" class="">Dashboard</a>
      <a href="foreman-appointments.html" class="foreman-nav" style="display:none">Job Board</a>
      <a href="appointments.html" class="">Appointments</a>
      <a href="jobs.html" class="">Jobs</a>
      <a href="messages.html" class="">Messages</a>
      <a href="invoices.html" class="">Invoices</a>
      <a href="customers.html" class="">Customers</a>
      <a href="revenue.html" class="">Revenue</a>
      <a href="inventory.html" class="" id="inventoryNavLink" style="display:none">Inventory</a>
      <a href="settings.html" class="active">Settings</a>
      <a href="profile.html" class="">Profile</a>
      <a href="#" id="mobileThemeToggle" class="mobile-nav-btn mobile-special">Theme</a>
      <a href="#" id="mobileLogoutBtn" class="mobile-nav-btn mobile-special">Logout</a>
    </nav>
    <div>
      <button id="themeToggle" class="btn" aria-label="Toggle theme">Theme</button>
      <button id="logoutBtn" class="btn" aria-label="Logout">Logout</button>
    </div>
  </div>
</header>
<main class="container" style="padding:16px 0">
  <h1>Settings</h1>

  <!-- Subscription Status Banner -->
  <div id="subscriptionBanner" class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; margin-bottom: 24px; display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
      <div>
        <h2 style="margin: 0 0 8px 0; color: white; font-size: 1.5rem;">üéâ <span id="subPlanName">Single Plan</span></h2>
        <p id="subStatusText" style="margin: 0; font-size: 1.1rem; opacity: 0.95;">Trial ends in <strong id="trialDaysLeft">14 days</strong></p>
      </div>
      <div style="text-align: right;">
        <p style="margin: 0 0 4px 0; font-size: 0.9rem; opacity: 0.9;">First billing date</p>
        <p id="billingDate" style="margin: 0; font-size: 1.2rem; font-weight: 600;">December 2, 2025</p>
      </div>
    </div>
  </div>
  </div>

  <!-- Terminal Settings Section -->
  <section class="settings-section" style="margin-bottom:16px;">
    <div id="terminal-settings-section">
      <!-- Content will be loaded dynamically -->
      <div class="muted">Terminal settings loading...</div>
    </div>
  </section>

  <!-- Shop Info + Services: side-by-side on desktop, stacked on mobile -->
  <div class="grid cols-2" style="gap:16px; margin-bottom:16px;">
  <!-- Shop Info Panel -->
  <div class="card" style="position:relative; overflow:visible;">
    <h3>Shop Info</h3>
    <img id="shopLogoPreview" src="" alt="Logo preview" style="position:absolute; top:8px; right:8px; width:64px; height:auto; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.12); display:none; object-fit:contain; background:var(--card); padding:4px; border:1px solid var(--line);" />
    <label>Shop Name</label><input id="shopName">
    <label>Phone</label><input id="shopPhone">
    <label>Email</label><input id="shopEmail">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label for="shopStreet">Street Address</label>
        <input id="shopStreet" autocomplete="street-address">
      </div>
      <div>
        <label for="shopZipcode">Zipcode</label>
        <input id="shopZipcode" autocomplete="postal-code">
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label for="shopCity">City</label>
        <input id="shopCity" autocomplete="address-level2">
      </div>
      <div>
        <label for="shopState">State</label>
        <input id="shopState" maxlength="2" style="text-transform:uppercase" autocomplete="address-level1">
      </div>
    </div>
    <label>Shop Logo</label><input id="shopLogoFile" type="file" accept="image/*">
    
    <!-- Google Business Search Section -->
    <div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--line);">
      <h4 style="margin-bottom:12px;">üîç Connect Your Google Business</h4>
      <p style="font-size:0.875rem;color:var(--muted);margin-bottom:12px;">Link your Google Business profile to send review requests to customers in their invoices.</p>
      
      <div id="googleBusinessInfo" style="display:none;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <span style="font-size:1.25rem;">‚úÖ</span>
          <strong id="googleBusinessName">Business Name</strong>
        </div>
        <a id="googleBusinessLink" href="" target="_blank" style="font-size:0.875rem;color:var(--primary);text-decoration:none;">View on Google</a>
        <button id="changeGoogleBusiness" class="btn" style="margin-top:8px;font-size:0.875rem;">Change</button>
      </div>
      
      <div id="googleSearchContainer">
        <!-- Primary: Manual Entry -->
        <div style="padding:16px;background:var(--bg);border-radius:8px;margin-bottom:12px;">
          <h5 style="margin:0 0 12px 0;font-size:0.9rem;">How to find your Google review link:</h5>
          <ol style="font-size:0.875rem;color:var(--muted);margin:0 0 16px 0;padding-left:20px;">
            <li style="margin-bottom:8px;"><strong>Click the Quick Search button below</strong> to open Google with your business info</li>
            <li style="margin-bottom:8px;">Click on your business name in the search results</li>
            <li style="margin-bottom:8px;">Click the "Reviews" tab</li>
            <li style="margin-bottom:8px;">Click "Write a review" button</li>
            <li style="margin-bottom:8px;">Copy the entire URL from your browser address bar</li>
            <li style="margin-bottom:8px;">Paste it below and save</li>
          </ol>
          
          <button id="quickSearchGoogle" class="btn primary" style="width:100%;margin-bottom:16px;font-size:1rem;padding:12px;">üîç Quick Search - Open Google for My Business</button>
          
          <label style="font-size:0.875rem;font-weight:600;display:block;margin-bottom:6px;">Business Name</label>
          <input id="manualBusinessName" placeholder="e.g., GR Automotive" style="margin-bottom:12px;">
          
          <label style="font-size:0.875rem;font-weight:600;display:block;margin-bottom:6px;">Google Review URL</label>
          <input id="manualGoogleUrl" placeholder="Paste your Google review URL here" style="margin-bottom:8px;">
          <p style="font-size:0.75rem;color:var(--muted);margin:0 0 12px 0;">
            üí° URL should contain google.com/maps or google.com/search with #lrd=
          </p>
          
          <button id="saveManualGoogleBusiness" class="btn info" style="width:100%;font-size:1rem;padding:12px;">üíæ Save Google Business Info</button>
        </div>
      </div>
    </div>
    
    <button id="saveShop" class="btn info" style="margin-top:16px">Save</button>
    <p id="shopSaved" class="notice"></p>
  </div>

  <!-- Services and Labor Panel -->
  <div class="card">
    <!-- Labor Rates Section (moved to top since services depend on rates) -->
    <div class="toolbar" style="justify-content:space-between">
      <h3>Manage Labor Rates</h3>
    </div>
    <p class="muted" style="margin-bottom:12px;font-size:0.9rem;">The first rate you add becomes your <strong>default rate</strong>. Click a rate to manage it.</p>
    <div id="labList"></div>
    <div class="grid cols-3" style="margin-top:10px">
      <input id="labName" placeholder="Rate name (e.g., Standard)">
      <input id="labRate" type="number" step="0.01" placeholder="$/hr">
      <button id="labAdd" class="btn primary">Add</button>
    </div>
    
    <!-- Services Section -->
    <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--line);">
      <h3>Services</h3>
      <p class="muted" style="margin-bottom:12px;font-size:0.9rem;">Services can be flat-price or labor-based (hours √ó rate).</p>
      <div id="svcList"></div>
      
      <!-- Add Service Form -->
      <div style="margin-top:12px;padding:12px;background:var(--bg);border-radius:8px;">
        <div style="margin-bottom:10px;">
          <input id="svcName" placeholder="Service name" style="width:100%;">
        </div>
        <div style="margin-bottom:10px;">
          <div class="pricing-type-pills" style="display:flex;gap:8px;">
            <button type="button" id="svcPricingFlatBtn" class="pricing-pill" data-value="flat">Flat Price</button>
            <button type="button" id="svcPricingLaborBtn" class="pricing-pill" data-value="labor_based">Labor-based</button>
          </div>
          <input type="hidden" name="svcPricingType" id="svcPricingTypeValue" value="">
          <style>
            .pricing-pill {
              flex: 1;
              padding: 12px 16px;
              border: 2px solid var(--line);
              border-radius: 8px;
              background: var(--card);
              color: var(--text);
              font-weight: 600;
              font-size: 0.95rem;
              cursor: pointer;
              transition: all 0.2s ease;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            }
            .pricing-pill:hover:not(.active) {
              border-color: var(--primary);
              background: var(--bg);
              transform: translateY(-1px);
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .pricing-pill.active {
              border-color: var(--primary);
              background: rgba(99, 102, 241, 0.15);
              color: var(--text);
              box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
              transform: translateY(-1px);
            }
          </style>
        </div>
        
        <!-- Flat Price Fields -->
        <div id="svcFlatFields">
          <input id="svcPrice" type="number" step="0.01" placeholder="Price ($)" style="width:100%;">
        </div>
        
        <!-- Labor-based Fields (hidden by default) -->
        <div id="svcLaborFields" style="display:none;">
          <div class="grid cols-2" style="gap:10px;">
            <div>
              <label style="font-size:0.85rem;color:var(--muted);">Labor Hours</label>
              <input id="svcLaborHours" type="number" step="0.25" min="0" placeholder="Hours (e.g., 1.5)">
            </div>
            <div>
              <label style="font-size:0.85rem;color:var(--muted);">Labor Rate</label>
              <select id="svcLaborRate" style="width:100%;">
                <option value="">-- Select Rate --</option>
              </select>
            </div>
          </div>
          <div id="svcLaborPreview" style="margin-top:8px;font-size:0.9rem;color:var(--muted);"></div>
        </div>
        
        <button id="svcAdd" class="btn primary" style="margin-top:10px;width:100%;">Add Service</button>
      </div>
      <p class="notice" style="margin-top:8px;">Click a service to manage it.</p>
    </div>
  </div>

</div>

  <!-- Shop Access & Team (hardcoded into page for reliability) -->
  <div class="card" id="xm-team-card" style="margin-bottom:16px;">
  <h2>Shop Access & Team</h2>
  <div class="grid cols-3">
    <div>
      <label>Shop Type</label>
      <select id="setShopType">
        <option>Mechanic</option>
        <option>Body</option>
        <option>Other</option>
      </select>
    </div>
    <div>
      <label>Staff Limit</label>
      <input id="setStaffLimit" type="number" min="1" value="3">
    </div>
    <div>
      <label>Join Code</label>
      <div style="position:relative;">
        <input id="setJoinCode" value="" readonly style="padding-right:40px;">
        <button id="btnCopyJoin" class="btn" type="button" title="Copy join code" style="position:absolute; right:5px; top:50%; transform:translateY(-50%); width:24px; height:24px; padding:0; display:flex; align-items:center; justify-content:center; border:none; background:none;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 1H4C3 1 2 2 2 3V17H4V3H16V1Z" fill="currentColor"/>
            <path d="M15 5H8C7 5 6 6 6 7V21C6 22 7 23 8 23H20C21 23 22 22 22 21V11C22 10 21 9 20 9H17V7C17 6 16 5 15 5ZM20 21H8V7H15V11H20V21Z" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div style="margin-top:8px;">
        <button id="btnRegenerateJoin" class="btn" type="button">Regenerate Code</button>
      </div>
    </div>
  </div>
  <div style="margin-top:16px">
    <h3>Staff List</h3>
    <div id="shopOwner" style="margin-bottom:8px; font-weight:600">Shop Owner: <span id="shopOwnerName">-</span></div>
    <table class="table" id="staffTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Pay Type</th><th>Hourly Rate</th><th>Actions</th></tr></thead><tbody></tbody></table>
        <style>
              .owner-badge {
                background: #ffd700;
                color: #041014;
                font-weight: bold;
                border-radius: 4px;
                padding: 2px 6px;
                margin-left: 6px;
                font-size: 0.9em;
              }
              .staff-section-header {
                background: rgba(0,0,0,0.04);
                color: var(--text);
                font-weight: 700;
                padding: 10px 8px;
                border-top: 1px solid var(--line);
              }
          .pay-type-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
          }
          .pay-type-badge.flat-rate {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
          }
          .pay-type-badge.hourly {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
          }
        </style>
    <p class="notice">Slots used: <span id="slotsUsed">0</span> / <span id="slotsMax">3</span></p>

    <!-- Invitations UI -->
      <!-- Invitations Panel -->
      <div id="invitations-section" style="margin-bottom:16px;">
        <div class="card">
          <h3>Pending Invitations</h3>
          <div id="pendingInvitesList"><div class="muted">Loading...</div></div>

          <h3 style="margin-top:12px">Invite Existing User</h3>
          <form id="inviteForm">
            <div class="grid cols-3">
              <input id="inviteEmailInput" type="email" placeholder="user@example.com" required>
              <select id="inviteRoleSelect">
                <option value="staff">Staff</option>
                <option value="service_writer">Service Writer</option>
                <option value="receptionist">Receptionist</option>
                <option value="admin">Admin</option>
                <option value="foreman">Foreman</option>
              </select>
              <button id="inviteSendBtn" class="btn primary" type="submit">Send Invitation</button>
            </div>
          </form>
          <p id="inviteNotice" class="notice" style="margin-top:8px;"></p>
          <p class="invite-note">üí° User must have an Xpose account to receive invitation</p>
        </div>
      </div>
  </div>
</div>

</main>

<!-- Confirmation Modal -->
<div id="confirmModal" class="modal-overlay hidden">
  <div class="modal-content card" style="max-width: 400px; margin: 20vh auto;">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmMessage" style="margin: 16px 0;"></p>
    <div class="toolbar" style="justify-content: flex-end; gap: 8px;">
      <button id="confirmCancel" class="btn">Cancel</button>
      <button id="confirmOk" class="btn danger">Remove</button>
    </div>
  </div>
</div>
<!-- Terminal Test Modal -->
<div id="terminalTestModal" class="modal-overlay hidden">
  <div class="modal-content card" style="max-width:520px; margin:12vh auto; padding:20px; position:relative;">
    <h3 style="margin-top:0;">Checking Terminal Connection</h3>
    <div style="display:flex;gap:12px;align-items:flex-start;">
      <div style="flex:1">
        <div class="terminal-test-graph" aria-hidden="true" style="height:90px; background:#0b1220; border-radius:6px; overflow:hidden; position:relative;">
          <svg class="heartbeat-svg" viewBox="0 0 200 50" preserveAspectRatio="none" style="width:200%;height:100%;position:absolute;right:-100%;top:0;">
            <polyline class="heartbeat-line" points="0,25 20,25 26,15 30,35 40,25 60,25 72,5 76,45 84,25 100,25 120,25 140,10 150,30 170,25 200,25" fill="none" stroke="#10b981" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"></polyline>
          </svg>
        </div>
        <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center;">
          <div class="terminal-test-msg" style="color:#334; font-weight:600;">Starting...</div>
          <div class="terminal-test-result" style="font-weight:700;">&nbsp;</div>
        </div>
        <div style="margin-top:12px; color:#666; font-size:0.95rem;">This will check the platform's ability to reach your registered terminal. Takes ~10s.</div>
      </div>
    </div>
    <div style="margin-top:16px; text-align:right;">
      <button class="terminal-test-close btn" disabled onclick="document.getElementById('terminalTestModal').classList.add('hidden')">Close</button>
    </div>
    <style>
      /* heartbeat animation: translate svg from right to left while testing */
      #terminalTestModal.testing .heartbeat-svg { animation: heartbeat-scroll 1s linear infinite; }
      @keyframes heartbeat-scroll { from { transform: translateX(0%);} to { transform: translateX(-50%);} }
      .terminal-test-result.success { color: #10b981; }
      .terminal-test-result.failed { color: #ef4444; }
      .modal-overlay { position: fixed; left:0; right:0; top:0; bottom:0; background: rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:1200; }
      .modal-overlay.hidden { display:none; }
    </style>
  </div>
</div>
  <!-- Role Selection Modal -->
  <div id="roleModal" class="modal-overlay hidden">
    <div class="modal-content card" style="max-width: 420px; margin: 18vh auto;">
      <h3 id="roleModalTitle">Edit Role</h3>
      <div style="margin:12px 0">
        <label for="roleSelect">Select role for <span id="roleModalTarget">user</span></label>
        <select id="roleSelect" style="width:100%; padding:8px; margin-top:8px">
          <option value="admin">admin</option>
          <option value="foreman">foreman</option>
          <option value="service_writer">service_writer</option>
          <option value="receptionist">receptionist</option>
          <option value="staff">staff</option>
        </select>
      </div>
      <div class="toolbar" style="justify-content: flex-end; gap: 8px; margin-top:12px;">
        <button id="roleCancel" class="btn">Cancel</button>
        <button id="roleSave" class="btn primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Staff Manage Modal -->
  <div id="staffManageModal" class="modal-overlay hidden">
    <div class="modal-content card" style="max-width: 380px; margin: 18vh auto; padding: 24px;">
      <h3 style="margin: 0 0 8px 0;">Manage Staff Member</h3>
      <p id="staffManageName" style="color: var(--muted); margin: 0 0 20px 0;">Staff Name</p>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button id="staffManagePayType" class="btn" style="width: 100%; padding: 14px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Change Pay Type
        </button>
        <button id="staffManageRemove" class="btn danger" style="width: 100%; padding: 14px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Remove from Shop
        </button>
      </div>
      <button id="staffManageCancel" class="btn" style="width: 100%; margin-top: 16px; padding: 12px;">Cancel</button>
    </div>
  </div>

  <!-- Labor Rate Management Modal -->
  <div id="laborRateModal" class="modal-overlay hidden">
    <div class="modal-content card" style="max-width: 400px; margin: 18vh auto; padding: 24px;">
      <h3 style="margin: 0 0 8px 0;">Manage Labor Rate</h3>
      <p id="laborRateModalName" style="color: var(--muted); margin: 0 0 16px 0; font-size: 1.1rem; font-weight: 600;">Standard - $125/hr</p>
      <div id="laborRateDefaultBadge" style="display:none; margin-bottom: 16px; padding: 8px 12px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; border-radius: 8px; font-weight: 600; text-align: center;">
        ‚≠ê Default Rate
      </div>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button id="laborRateSwitchDefault" class="btn" style="width: 100%; padding: 14px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; border: none;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
          Set as Default
        </button>
        <button id="laborRateRemove" class="btn danger" style="width: 100%; padding: 14px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Remove Rate
        </button>
      </div>
      <button id="laborRateCancel" class="btn" style="width: 100%; margin-top: 16px; padding: 12px;">Cancel</button>
    </div>
  </div>

  <!-- Service Management Modal -->
  <div id="serviceModal" class="modal-overlay hidden">
    <div class="modal-content card" style="max-width: 400px; margin: 18vh auto; padding: 24px;">
      <h3 style="margin: 0 0 8px 0;">Manage Service</h3>
      <p id="serviceModalName" style="color: var(--muted); margin: 0 0 8px 0; font-size: 1.1rem; font-weight: 600;">Oil Change</p>
      <p id="serviceModalPrice" style="color: var(--text); margin: 0 0 16px 0; font-size: 1rem;">$49.99 (Flat)</p>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button id="serviceRemove" class="btn danger" style="width: 100%; padding: 14px; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
          Remove Service
        </button>
      </div>
      <button id="serviceCancel" class="btn" style="width: 100%; margin-top: 16px; padding: 12px;">Cancel</button>
    </div>
  </div>

  <!-- Pay Type Selection Modal -->
  <div id="payTypeModal" class="modal-overlay hidden">
    <div class="modal-content card" style="max-width: 380px; margin: 18vh auto; padding: 24px;">
      <h3 style="margin: 0 0 8px 0;">Select Pay Type</h3>
      <p id="payTypeName" style="color: var(--muted); margin: 0 0 20px 0;">Staff Name</p>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <button id="payTypeFlatRate" class="btn" style="width: 100%; padding: 16px; font-size: 1rem; display: flex; align-items: center; gap: 12px; background: var(--bg); border: 2px solid var(--line); color: var(--text);">
          <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); display: flex; align-items: center; justify-content: center;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>
          </div>
          <div style="text-align: left;">
            <div style="font-weight: 600;">Flat Rate</div>
            <div style="font-size: 0.85rem; color: var(--muted);">Paid per job completed</div>
          </div>
        </button>
        <button id="payTypeHourly" class="btn" style="width: 100%; padding: 16px; font-size: 1rem; display: flex; align-items: center; gap: 12px; background: var(--bg); border: 2px solid var(--line); color: var(--text);">
          <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #10b981 0%, #34d399 100%); display: flex; align-items: center; justify-content: center;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div style="text-align: left;">
            <div style="font-weight: 600;">Hourly</div>
            <div style="font-size: 0.85rem; color: var(--muted);">Paid based on hours clocked</div>
          </div>
        </button>
      </div>
      <button id="payTypeCancel" class="btn" style="width: 100%; margin-top: 16px; padding: 12px;">Cancel</button>
    </div>
  </div>

<footer class="container">¬© Xpose Market</footer>
<script src="vendor/supabase.umd.js"></script>
<script type="module" src="app.js"></script>

<script>
// Populate the hardcoded Shop Access & Team panel from Supabase
document.addEventListener('DOMContentLoaded', function(){
  const SUPA_URL = 'https://hxwufjzyhtwveyxbkkya.supabase.co';
  const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4d3Vmanp5aHR3dmV5eGJra3lhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MjU0MjAsImV4cCI6MjA3ODMwMTQyMH0.nN7MGoYyqwhonOSPBJlFEZoZrOEAIRP79l43FZK5nh8';

  function waitForSupabaseClient(timeout = 5000){
    return new Promise((resolve) => {
      const start = Date.now();
      function tryGet(){
        // If a shared client already exists, return it
        if(window._supabaseClient){
          resolve(window._supabaseClient);
          return;
        }

        // If vendor lib is available, create a single shared client (only once)
        if(window.supabase && typeof window.supabase.createClient === 'function'){
          try{
            window._supabaseClient = window._supabaseClient || window.supabase.createClient(SUPA_URL, SUPA_KEY);
            resolve(window._supabaseClient);
            return;
          }catch(e){
            console.warn('Error creating shared Supabase client', e);
          }
        }

        if(Date.now() - start > timeout){ resolve(null); return; }
        setTimeout(tryGet, 200);
      }
      tryGet();
    });
  }

  (async function(){
    const elType = document.getElementById('setShopType');
    const elLimit = document.getElementById('setStaffLimit');
    const elJoin = document.getElementById('setJoinCode');
    const btnCopy = document.getElementById('btnCopyJoin');
    const btnRegen = document.getElementById('btnRegenerateJoin');
    const tbody = document.querySelector('#staffTable tbody');
    const slotsUsedEl = document.getElementById('slotsUsed');
    const slotsMaxEl = document.getElementById('slotsMax');
    const ownerEl = document.getElementById('shopOwnerName');
    try{
      // Ensure we have a Supabase client
      const sup = await waitForSupabaseClient(8000);
      if(!sup){ tbody.innerHTML = '<tr><td colspan="6" style="color:red;">[ERROR] Supabase client unavailable.</td></tr>'; return; }
      // 1. Get current Supabase Auth user
      const { data: authData, error: authErr } = await sup.auth.getUser();
      const authId = authData?.user?.id || null;
      if(!authId){
        tbody.innerHTML = '<tr><td colspan="6" style="color:red;">[ERROR] No Supabase Auth user found. Please log in.</td></tr>';
        return;
      }
      // 2. Query users table for this auth user id (try `id` first, then legacy `auth_id`)
      let currentUser = null;
      try{
        const { data: byId } = await sup.from('users').select('*').eq('id', authId).limit(1);
        currentUser = byId && byId[0] ? byId[0] : null;
      }catch(iErr){ console.warn('Error querying users by id', iErr); }

      if(!currentUser){
        try{
          const { data: userRows } = await sup.from('users').select('*').eq('auth_id', authId).limit(1);
          currentUser = userRows && userRows[0] ? userRows[0] : null;
        }catch(uErr){ console.warn('Error querying users by auth_id', uErr); }
      }

      

      // If no match on auth_id, try matching by email (many existing rows may not have auth_id populated)
      if(!currentUser){
        const authEmail = authData?.user?.email || null;
        if(authEmail){
          try{
            const { data: byEmail } = await sup.from('users').select('*').eq('email', authEmail).limit(1);
            currentUser = byEmail && byEmail[0] ? byEmail[0] : null;
            if(currentUser){
                  console.warn('[settings] Found users row by email fallback. Consider setting users.auth_id for this user to', authId);
                  console.log('[settings] users by email ->', currentUser);
                }
          }catch(e){ console.warn('Error querying users by email', e); }
        }
      }

      if(!currentUser){
        tbody.innerHTML = '<tr><td colspan="6" style="color:red;">[ERROR] No user record found for your account. Please ensure a `users` row exists with your email or auth_id.</td></tr>';
        return;
      }

      if(!currentUser.shop_id){
        tbody.innerHTML = '<tr><td colspan="6" style="color:red;">[ERROR] Your user record does not have a `shop_id` assigned. Please ask an admin to assign your account to a shop.</td></tr>';
        return;
      }
      // 3. Query shops table for this shop_id
      const { data: shopRows, error: shopErr } = await sup.from('shops').select('*').eq('id', currentUser.shop_id).limit(1);
      const shop = shopRows && shopRows[0] ? shopRows[0] : null;
      
      if(!shop){
        tbody.innerHTML = '<tr><td colspan="6" style="color:red;">[ERROR] No shop found for your user/shop assignment.</td></tr>';
        return;
      }
      // shop has been resolved from the authenticated user's shop_id above

      // Fill basic shop fields
      if(elType) elType.value = shop.type || '';
      if(elLimit) elLimit.value = shop.staff_limit || 3;
      if(elJoin) elJoin.value = shop.join_code || '';
      if(slotsMaxEl) slotsMaxEl.textContent = String(shop.staff_limit || 3);

      // Render team helper (fetch and render staff/users combined)
      async function renderTeam() {
        // Fetch staff from both users and shop_staff then merge
        let usersLocal = [];
        try{ const { data: udata } = await sup.from('users').select('*').eq('shop_id', shop.id); if(udata) usersLocal = udata; }catch(e){ console.warn('Error querying users table', e); }
        let staffData = [];
        try{ const { data: sdata } = await sup.from('shop_staff').select('*').eq('shop_id', shop.id); if(sdata) staffData = sdata.map(s => ({ shop_staff_id: s.id, auth_id: s.auth_id || null, first: s.first_name, last: s.last_name, email: s.email, role: s.role, shop_id: s.shop_id, hourly_rate: s.hourly_rate, pay_type: s.pay_type, is_staff:true })); }catch(e){ console.warn('Error querying shop_staff', e); }

        // Combine and dedupe by email, but prefer shop_staff entries for role/display
        const combined = [...(usersLocal || []), ...(staffData || [])];
        const emailMap = new Map();
        combined.forEach(u => {
          const key = (u.email || '').toLowerCase();
          if(!emailMap.has(key)) {
            emailMap.set(key, Object.assign({}, u));
          } else {
            const existing = emailMap.get(key);
            // If shop_staff entry, prefer its role and shop_staff_id
            if(u.is_staff) {
              existing.role = u.role;
              existing.shop_staff_id = u.shop_staff_id || existing.shop_staff_id;
              existing.is_staff = true;
              // prefer staff name if users row lacks it
              existing.first = existing.first || u.first;
              existing.last = existing.last || u.last;
              // prefer shop_staff pay fields
              existing.hourly_rate = (typeof u.hourly_rate !== 'undefined') ? u.hourly_rate : existing.hourly_rate;
              existing.pay_type = (typeof u.pay_type !== 'undefined') ? u.pay_type : existing.pay_type;
            } else {
              // If existing is staff and current is users, don't overwrite role
              existing.first = existing.first || u.first || u.first_name;
              existing.last = existing.last || u.last || u.last_name;
              existing.email = existing.email || u.email;
              // merge pay fields if missing from staff
              existing.hourly_rate = (typeof existing.hourly_rate !== 'undefined' && existing.hourly_rate !== null) ? existing.hourly_rate : (u.hourly_rate || existing.hourly_rate);
              existing.pay_type = (typeof existing.pay_type !== 'undefined' && existing.pay_type !== null) ? existing.pay_type : (u.pay_type || existing.pay_type);
            }
          }
        });
        const allTeamMembers = Array.from(emailMap.values());

        // Determine owner (admin) - prefer users table admin
        let owner = allTeamMembers.find(x => x.role === 'admin' && !x.is_staff) || allTeamMembers.find(x => x.role === 'admin') || null;
        if(owner){ ownerEl.textContent = `${owner.first || ''} ${owner.last || ''} - ${owner.email || ''}`; }
        else ownerEl.textContent = 'None';

        // Populate staff table (grouped by role for predictable ordering)
        tbody.innerHTML = '';
        if(!allTeamMembers.length){
          tbody.innerHTML = '<tr><td colspan="6" class="muted">No team members found.</td></tr>';
          if(slotsUsedEl) slotsUsedEl.textContent = '0';
        } else {
          let used = 0;
          let shopOwnerId = shop.owner_id ? String(shop.owner_id).trim() : null;

          // Helper: insert a section header row
          function insertSectionHeader(title){
            const shr = document.createElement('tr');
            const cell = document.createElement('td');
            cell.colSpan = 6;
            cell.className = 'staff-section-header';
            cell.textContent = title;
            shr.appendChild(cell);
            tbody.appendChild(shr);
          }

          // Helper: render a single member row (keeps existing behavior)
          function renderMemberRow(u){
            const tr = document.createElement('tr');
            const isOwner = shopOwnerId && String(u.id).trim() === shopOwnerId;
            if (!isOwner && u.shop_staff_id) tr.dataset.staffId = u.shop_staff_id;
            if (u.id) tr.dataset.userId = u.id;

            const tdName = document.createElement('td');
            tdName.setAttribute('data-label', 'Name');
            tdName.textContent = `${u.first||u.first_name||''} ${u.last||u.last_name||''}`;
            if(isOwner){
              const badge = document.createElement('span');
              badge.className = 'owner-badge';
              badge.textContent = 'Owner';
              tdName.appendChild(badge);
            }
            tr.appendChild(tdName);

            const tdEmail = document.createElement('td');
            tdEmail.setAttribute('data-label', 'Email');
            tdEmail.textContent = u.email || '';
            tr.appendChild(tdEmail);

            const tdRole = document.createElement('td');
            tdRole.setAttribute('data-label', 'Role');
            if(isOwner){
              tdRole.textContent = 'owner';
            } else {
              const roleEl = document.createElement('span');
              roleEl.className = 'role-badge';
              roleEl.textContent = (u.role || 'staff');
              roleEl.style.border = '1px solid var(--line)';
              roleEl.style.padding = '4px 8px';
              roleEl.style.borderRadius = '6px';
              roleEl.style.cursor = 'pointer';
              roleEl.style.display = 'inline-block';
              roleEl.style.background = 'var(--card)';
              roleEl.style.color = 'var(--text)';
              roleEl.title = 'Click to change role';
              roleEl.dataset.email = (u.email || '').toLowerCase();
              roleEl.dataset.role = (u.role || 'staff');
              roleEl.addEventListener('click', () => openRoleModal(roleEl.dataset.email, roleEl.dataset.role, tr, roleEl));
              tdRole.appendChild(roleEl);
            }
            tr.appendChild(tdRole);

            // Pay Type cell
            const tdPayType = document.createElement('td');
            tdPayType.setAttribute('data-label', 'Pay Type');
            // Determine hourly status: show 'Hourly' only when `pay_type` is explicitly set to 'hourly'.
            // This prevents entering an `hourly_rate` for flat users from flipping their Pay Type UI.
            const hasPayTypeProp = (typeof u.pay_type !== 'undefined');
            const isHourly = hasPayTypeProp ? ((u.pay_type || '').toString().toLowerCase() === 'hourly') : false;
            const payTypeBadge = document.createElement('span');
            payTypeBadge.className = 'pay-type-badge';
            payTypeBadge.textContent = isHourly ? 'Hourly' : 'Flat Rate';
            payTypeBadge.style.padding = '4px 10px';
            payTypeBadge.style.borderRadius = '12px';
            payTypeBadge.style.fontSize = '0.85em';
            payTypeBadge.style.fontWeight = '600';
            payTypeBadge.style.display = 'inline-block';
            if (isHourly) {
              payTypeBadge.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
              payTypeBadge.style.color = 'white';
            } else {
              payTypeBadge.style.background = 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)';
              payTypeBadge.style.color = 'white';
            }
            tdPayType.appendChild(payTypeBadge);
            tr.appendChild(tdPayType);

            // Hourly Rate cell
            const tdRate = document.createElement('td');
            tdRate.setAttribute('data-label', 'Hourly Rate');
            const rateVal = (u.hourly_rate != null) ? u.hourly_rate : (u.rate != null ? u.rate : '');
            const rateInput = document.createElement('input');
            rateInput.type = 'number';
            rateInput.step = '0.01';
            rateInput.placeholder = '0.00';
            rateInput.value = (rateVal !== '') ? String(rateVal) : '';
            rateInput.style.width = '100px';
            rateInput.dataset.email = (u.email || '').toLowerCase();
            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn';
            saveBtn.type = 'button';
            saveBtn.title = 'Save hourly rate';
            saveBtn.textContent = '‚úì';
            saveBtn.style.marginLeft = '8px';
            saveBtn.style.padding = '6px 8px';
            saveBtn.disabled = true;
            saveBtn.style.opacity = '0.5';
            rateInput.addEventListener('input', () => { saveBtn.disabled = false; saveBtn.style.opacity = '1'; });
            saveBtn.addEventListener('click', async (e) => {
              e.preventDefault();
              const raw = rateInput.value;
              const num = isNaN(Number(raw)) ? 0 : Number(raw);
              try {
                let res = null;
                if (u.shop_staff_id) {
                  // If user's pay_type is explicitly 'hourly', keep it. Otherwise, preserve flat by setting pay_type to 'flat'.
                  const payTypeToSet = (u.pay_type && (u.pay_type||'').toString().toLowerCase() === 'hourly') ? 'hourly' : 'flat';
                  res = await sup.from('shop_staff').update({ hourly_rate: num, pay_type: payTypeToSet }).eq('id', u.shop_staff_id).select();
                } else if (u.id) {
                  const payTypeToSet = (u.pay_type && (u.pay_type||'').toString().toLowerCase() === 'hourly') ? 'hourly' : 'flat';
                  res = await sup.from('users').update({ hourly_rate: num, pay_type: payTypeToSet }).eq('id', u.id).select();
                } else if (u.auth_id) {
                  const payTypeToSet = (u.pay_type && (u.pay_type||'').toString().toLowerCase() === 'hourly') ? 'hourly' : 'flat';
                  res = await sup.from('users').update({ hourly_rate: num, pay_type: payTypeToSet }).eq('auth_id', u.auth_id).select();
                }
                if (res && res.error) throw res.error;
                showNotification('Hourly rate saved.', 'success');
                saveBtn.disabled = true; saveBtn.style.opacity = '0.5';
                await renderTeam();
              } catch (ex) {
                console.error('Failed to save hourly rate', ex);
                const missingColMsg = ex?.message || '';
                if ((ex && ex.code === 'PGRST204') || /Could not find the 'hourly_rate' column/i.test(missingColMsg)) {
                  showNotification('DB column `hourly_rate` missing. See console for migration SQL.', 'error');
                  console.info('Add the `hourly_rate` column to `shop_staff` (recommended) with this SQL:\n');
                  console.info("ALTER TABLE shop_staff ADD COLUMN hourly_rate numeric(10,2);");
                  console.info('Optionally backfill from users.hourly_rate then set a default:');
                  console.info("UPDATE shop_staff s SET hourly_rate = u.hourly_rate FROM users u WHERE (s.auth_id IS NOT NULL AND s.auth_id = u.auth_id) OR (s.email IS NOT NULL AND lower(s.email) = lower(u.email));");
                } else {
                  showNotification('Failed to save hourly rate.', 'error');
                }
              }
            });
            tdRate.appendChild(rateInput);
            tdRate.appendChild(saveBtn);
            tr.appendChild(tdRate);

            const tdAct = document.createElement('td');
            tdAct.setAttribute('data-label', 'Actions');
            const manageBtn = document.createElement('button');
            manageBtn.className = 'btn';
            manageBtn.textContent = 'Manage';
            manageBtn.style.background = 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)';
            manageBtn.style.color = 'white';
            manageBtn.style.border = 'none';
            manageBtn.addEventListener('click', () => { openStaffManageModal(u, tr); });
            tdAct.appendChild(manageBtn);
            tr.appendChild(tdAct);
            tbody.appendChild(tr);
            return !isOwner; // return true if counts toward used slots
          }

          // Group members into sections
          const groups = { top: [], foreman: [], staff: [], service_writer: [], receptionist: [], others: [] };
          allTeamMembers.forEach(u => {
            const isOwner = shopOwnerId && String(u.id).trim() === shopOwnerId;
            if (isOwner || (u.role === 'admin')) groups.top.push(u);
            else if (u.role === 'foreman') groups.foreman.push(u);
            else if (!u.role || u.role === 'staff') groups.staff.push(u);
            else if (u.role === 'service_writer') groups.service_writer.push(u);
            else if (u.role === 'receptionist') groups.receptionist.push(u);
            else groups.others.push(u);
          });

          const sections = [
            { title: 'Admin / Owner', items: groups.top },
            { title: 'Foreman', items: groups.foreman },
            { title: 'Staff', items: groups.staff },
            { title: 'Service Writer', items: groups.service_writer },
            { title: 'Receptionist', items: groups.receptionist },
            { title: 'Other', items: groups.others }
          ];

          // Render sections in order
          sections.forEach((sec, idx) => {
            if (!sec.items || sec.items.length === 0) return;
            insertSectionHeader(sec.title);
            sec.items.forEach(u => {
              const counts = renderMemberRow(u);
              if (counts) used++;
            });
          });

          if(slotsUsedEl) slotsUsedEl.textContent = String(used);
        }
      }

      // Initial render
      await renderTeam();

      // --- Invitations: fetch & UI wiring ---
      async function fetchPendingInvitations() {
        try {
          const { data, error } = await sup
            .from('shop_invitations')
            .select('*')
            .eq('shop_id', shop.id)
            .eq('status', 'pending')
            .order('created_at', { ascending: false });

          if (error) throw error;
          const listEl = document.getElementById('pendingInvitesList');
          if (!listEl) return;
          listEl.innerHTML = '';
          if (!data || data.length === 0) {
            listEl.innerHTML = '<div class="muted">No pending invitations.</div>';
            return;
          }

          data.forEach(inv => {
            const item = document.createElement('div');
            item.className = 'pending-invite-item';
            item.style.display = 'flex';
            item.style.justifyContent = 'space-between';
            item.style.alignItems = 'center';
            item.style.padding = '8px 0';
            item.innerHTML = `
              <div>
                <div style="font-weight:600">${inv.invited_email}</div>
                <div style="color:var(--muted)">Role: ${inv.role} ‚Ä¢ Sent ${new Date(inv.created_at).toLocaleDateString()}</div>
              </div>
              <div>
                <button class="btn" data-invite-id="${inv.id}" data-action="cancel">Cancel</button>
              </div>
            `;
            listEl.appendChild(item);
          });

          // Wire cancel buttons
          listEl.querySelectorAll('button[data-action="cancel"]').forEach(b => {
            b.addEventListener('click', async (e) => {
              const id = b.getAttribute('data-invite-id');
              if (!id) return;
              
              const confirmed = await showConfirm('Cancel this invitation?', 'Cancel Invite', 'Keep');
              if (!confirmed) return;
              
              try {
                const { error } = await sup.from('shop_invitations').delete().eq('id', id);
                if (error) throw error;
                showInviteNotification('Invitation cancelled successfully.', 'success');
                fetchPendingInvitations();
              } catch (ex) {
                console.error('Error canceling invitation:', ex);
                showInviteNotification('Failed to cancel invitation.', 'error');
              }
            });
          });
        } catch (ex) {
          console.error('Error fetching pending invitations:', ex);
        }
      }

      // Helper to show invite notification
      function showInviteNotification(message, type = 'success') {
        const noticeEl = document.getElementById('inviteNotice');
        if (!noticeEl) return;
        noticeEl.textContent = message;
        noticeEl.className = 'notice ' + (type === 'error' ? 'danger' : 'success');
        setTimeout(() => {
          noticeEl.textContent = '';
          noticeEl.className = 'notice';
        }, 4000);
      }

      // Invite form handler
      const inviteForm = document.getElementById('inviteForm');
      if (inviteForm) {
        inviteForm.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          const emailInput = document.getElementById('inviteEmailInput');
          const roleSelect = document.getElementById('inviteRoleSelect');
          const inviteEmail = (emailInput?.value || '').toLowerCase().trim();
          const inviteRole = (roleSelect?.value || 'staff');
          if (!inviteEmail) {
            showInviteNotification('Please enter an email address', 'error');
            return;
          }

          try {
            // 1. Check if user exists in shop_staff OR users table (need auth_id to identify them)
            let targetAuthId = null;
            let targetEmail = inviteEmail;
            let targetFirstName = '';
            let targetLastName = '';

            // First check shop_staff by email (case-insensitive)
            const { data: staffUsers, error: staffErr } = await sup
              .from('shop_staff')
              .select('auth_id,email,first_name,last_name')
              .ilike('email', inviteEmail)
              .limit(1);
            
            if (staffErr) {
              console.error('Error checking shop_staff table:', staffErr);
            }
            
            const staffUser = staffUsers && staffUsers.length > 0 ? staffUsers[0] : null;
            if (staffUser && staffUser.auth_id) {
              targetAuthId = staffUser.auth_id;
              targetFirstName = staffUser.first_name || '';
              targetLastName = staffUser.last_name || '';
              console.log('Found user in shop_staff:', staffUser);
            }

            // If not found in shop_staff, check users table
            if (!targetAuthId) {
              const { data: existingUsers, error: userErr } = await sup
                .from('users')
                .select('id,email,auth_id,first_name,last_name')
                .ilike('email', inviteEmail)
                .limit(1);
              
              if (userErr) {
                console.error('Error checking users table:', userErr);
              }
              
              const existingUser = existingUsers && existingUsers.length > 0 ? existingUsers[0] : null;
              if (existingUser) {
                // Use id as auth_id if auth_id is not set (most users have id = auth_id)
                targetAuthId = existingUser.auth_id || existingUser.id;
                targetFirstName = existingUser.first_name || existingUser.first || '';
                targetLastName = existingUser.last_name || existingUser.last || '';
                console.log('Found user in users table:', existingUser);
              }
            }

            // If still not found anywhere, they don't have an account
            if (!targetAuthId) {
              showInviteNotification(
                "This user doesn't have an Xpose account yet. Ask them to sign up first.",
                'error'
              );
              console.log('User not found in shop_staff or users:', inviteEmail);
              return;
            }

            console.log('Found user with auth_id:', targetAuthId);

            // 2. Check if already a staff member at THIS shop (by auth_id + shop_id)
            const { data: existingStaff } = await sup
              .from('shop_staff')
              .select('id')
              .eq('auth_id', targetAuthId)
              .eq('shop_id', shop.id)
              .limit(1);
            const alreadyMember = existingStaff && existingStaff.length > 0;
            
            if (alreadyMember) {
              showInviteNotification('This user is already a staff member at this shop.', 'error');
              return;
            }

            // 3. Check for existing pending invitation (use ilike for case-insensitive)
            const { data: existingInvites } = await sup
              .from('shop_invitations')
              .select('id')
              .ilike('invited_email', inviteEmail)
              .eq('shop_id', shop.id)
              .eq('status', 'pending')
              .limit(1);
            const existingInvite = existingInvites && existingInvites.length > 0 ? existingInvites[0] : null;
            
            if (existingInvite) {
              showInviteNotification('An invitation has already been sent to this email.', 'error');
              return;
            }

            // 4. Create invitation with auth_id so we can identify them when they accept
            const { error: insertError } = await sup
              .from('shop_invitations')
              .insert({
                shop_id: shop.id,
                invited_by_user_id: currentUser.id,
                invited_email: targetEmail,
                invited_auth_id: targetAuthId,
                role: inviteRole
              });
            if (insertError) throw insertError;

            showInviteNotification('Invitation sent successfully!', 'success');
            if (emailInput) emailInput.value = '';
            if (roleSelect) roleSelect.value = 'staff';
            fetchPendingInvitations();
          } catch (ex) {
            console.error('Error sending invitation:', ex);
            showInviteNotification('Failed to send invitation. Please try again.', 'error');
          }
        });
      }

      // Initial invitations load
      try { fetchPendingInvitations(); } catch(e){}

      // Wire copy button
      if(btnCopy && elJoin){
        btnCopy.addEventListener('click', async function(){
          try{
            const text = (elJoin.value || '').toString();
            if(!text) return;
            if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(text);
            else { elJoin.select(); document.execCommand('copy'); }
            const prev = btnCopy.textContent; btnCopy.textContent = 'Copied!'; setTimeout(()=> btnCopy.textContent = prev, 1500);
          }catch(ex){ console.warn('copy failed', ex); alert('Could not copy join code.'); }
        });
      }

      // Role modal helpers
      const roleModal = document.getElementById('roleModal');
      const roleSelect = document.getElementById('roleSelect');
      const roleModalTarget = document.getElementById('roleModalTarget');
      const roleSaveBtn = document.getElementById('roleSave');
      const roleCancelBtn = document.getElementById('roleCancel');
      // modal context must be declared early to avoid TDZ when openRoleModal is invoked
      let roleModalContext = { email: null, staffId: null, row: null, badge: null };

      function openRoleModal(email, currentRole, row, badgeEl){
        // Try to get staffId from row dataset if present
        let staffId = null;
        if (row && row.dataset && row.dataset.staffId) staffId = row.dataset.staffId;
        roleModalContext = { email: (email||'').toLowerCase(), staffId, row: row, badge: badgeEl };
        if(roleModalTarget) roleModalTarget.textContent = roleModalContext.email || 'user';
        if(roleSelect) roleSelect.value = currentRole || 'staff';
        if(roleModal) roleModal.classList.remove('hidden');
      }

      function closeRoleModal(){
        roleModalContext = { email: null, staffId: null, row: null, badge: null };
        if(roleModal) roleModal.classList.add('hidden');
      }

      roleCancelBtn?.addEventListener('click', (e) => { e.preventDefault(); closeRoleModal(); });

      roleSaveBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        const newRole = roleSelect.value;
        const staffId = roleModalContext.staffId;
        const badge = roleModalContext.badge;

        let updateSuccess = false;
        let updateError = null;
        let affectedRows = 0;

        // Debug log
        console.log('[RoleChange] Attempting shop_staff update:', { staffId, newRole });

        // Only update shop_staff by staffId
        if(sup && staffId){
          try {
            const staffRes = await sup.from('shop_staff').update({ role: newRole }).eq('id', staffId).select();
            console.log('[RoleChange] Supabase shop_staff update response:', staffRes);
            const staffRows = Array.isArray(staffRes?.data) ? staffRes.data.length : 0;
            affectedRows = staffRows;
            if (affectedRows > 0) {
              updateSuccess = true;
            } else {
              updateError = staffRes?.error || new Error('No matching shop_staff row found for update.');
            }
          } catch (ex) {
            console.error('[RoleChange] Supabase shop_staff update exception:', ex);
            updateError = ex;
          }
        }

        if(updateSuccess){
          // optimistic UI update
          if(badge) { badge.textContent = newRole; badge.dataset.role = newRole; }
          // Re-fetch and re-render team list to reflect persisted changes
          try { await renderTeam(); } catch(e){ console.warn('Could not refresh team after role update', e); }
        } else {
          // Show error notification
          alert('Failed to save role change. No matching user/staff found for update. Please check the email or try again. ' + (updateError?.message || ''));
        }

        closeRoleModal();
      });

      // Staff Manage Modal helpers
      const staffManageModal = document.getElementById('staffManageModal');
      const staffManageName = document.getElementById('staffManageName');
      const staffManagePayTypeBtn = document.getElementById('staffManagePayType');
      const staffManageRemoveBtn = document.getElementById('staffManageRemove');
      const staffManageCancelBtn = document.getElementById('staffManageCancel');
      
      // Pay Type Modal helpers
      const payTypeModal = document.getElementById('payTypeModal');
      const payTypeName = document.getElementById('payTypeName');
      const payTypeFlatRateBtn = document.getElementById('payTypeFlatRate');
      const payTypeHourlyBtn = document.getElementById('payTypeHourly');
      const payTypeCancelBtn = document.getElementById('payTypeCancel');
      
      let staffManageContext = { user: null, row: null };
      let payTypeContext = { user: null, row: null };
      
      function openStaffManageModal(user, row) {
        staffManageContext = { user, row };
        const fullName = `${user.first || user.first_name || ''} ${user.last || user.last_name || ''}`.trim() || user.email;
        staffManageName.textContent = fullName;
        // Hide remove button for shop owner or when there's no shop_staff record
        try {
          const isOwner = shopOwnerId && String(user.id).trim() === shopOwnerId;
          if (isOwner || !user.shop_staff_id) {
            staffManageRemoveBtn.style.display = 'none';
          } else {
            staffManageRemoveBtn.style.display = '';
          }
        } catch (e) {
          // fallback: show remove only when shop_staff_id present
          if (!user.shop_staff_id) staffManageRemoveBtn.style.display = 'none';
          else staffManageRemoveBtn.style.display = '';
        }
        staffManageModal.classList.remove('hidden');
      }
      
      function closeStaffManageModal() {
        staffManageContext = { user: null, row: null };
        staffManageModal.classList.add('hidden');
      }
      
      function openPayTypeModal() {
        const user = staffManageContext.user;
        const row = staffManageContext.row;
        if (!user) return;
        // preserve context specifically for the pay type modal before clearing the manage modal
        payTypeContext = { user, row };
        const fullName = `${user.first || user.first_name || ''} ${user.last || user.last_name || ''}`.trim() || user.email;
        payTypeName.textContent = fullName;
        closeStaffManageModal();
        payTypeModal.classList.remove('hidden');
      }
      
      function closePayTypeModal() {
        payTypeModal.classList.add('hidden');
        payTypeContext = { user: null, row: null };
      }
      
      // Wire up Staff Manage Modal buttons
      staffManageCancelBtn?.addEventListener('click', closeStaffManageModal);
      
      staffManagePayTypeBtn?.addEventListener('click', openPayTypeModal);
      
      staffManageRemoveBtn?.addEventListener('click', async () => {
        const user = staffManageContext.user;
        if (!user) return;
        
        closeStaffManageModal();
        
        const fullName = `${user.first || user.first_name || ''} ${user.last || user.last_name || ''}`.trim();
        const confirmed = await showConfirm(`Are you sure you want to remove ${fullName} from this shop?`, 'Remove', 'Cancel');
        if (!confirmed) return;
        
        // Remove from shop_staff
        if (user.shop_staff_id) {
          try {
            const delRes = await sup.from('shop_staff').delete().eq('id', user.shop_staff_id).select();
            const delErr = delRes?.error || null;
            console.log('[StaffManage] shop_staff delete response:', delRes);
            if (delErr) {
              showNotification('Failed to remove staff member: ' + (delErr.message || delErr), 'error');
              return;
            }
            // Also set shop_id to null in users row (by email or auth_id)
            let userUpdateErr = null;
            if (user.auth_id) {
              const updRes = await sup.from('users').update({ shop_id: null }).eq('auth_id', user.auth_id).select();
              if (updRes?.error) userUpdateErr = updRes.error;
            }
            if (!userUpdateErr && user.email) {
              const updRes2 = await sup.from('users').update({ shop_id: null }).eq('email', user.email).select();
              if (updRes2?.error) userUpdateErr = updRes2.error;
            }
            if (userUpdateErr) {
              showNotification('Staff removed, but could not update users row: ' + (userUpdateErr.message || userUpdateErr), 'error');
            } else {
              showNotification('Staff member removed.', 'success');
            }
            await renderTeam();
          } catch (ex) {
            showNotification('Error removing staff member: ' + (ex.message || ex), 'error');
          }
        } else {
          showNotification('Could not find staff record to remove.', 'error');
        }
      });
      
      // Wire up Pay Type Modal buttons
      payTypeCancelBtn?.addEventListener('click', closePayTypeModal);
      
      payTypeFlatRateBtn?.addEventListener('click', async () => {
        const user = payTypeContext.user;
        console.log('[PayType] FlatRate clicked, payTypeContext user:', user);
        if (!user) return;

        try {
          // Prefer updating shop_staff, fall back to users table
          if (user.shop_staff_id) {
            const res = await sup.from('shop_staff').update({ hourly_rate: 0, pay_type: 'flat' }).eq('id', user.shop_staff_id).select();
            if (res?.error) throw res.error;
            console.log('[PayType] Updated shop_staff hourly_rate -> 0 and pay_type -> flat', res);
          } else if (user.auth_id || user.id || user.email) {
            // Try updating users table by auth_id, then id, then email
            let updRes = null;
            if (user.auth_id) updRes = await sup.from('users').update({ hourly_rate: 0 }).eq('auth_id', user.auth_id).select();
            if ((updRes && updRes.error) || !updRes) {
              if (user.id) updRes = await sup.from('users').update({ hourly_rate: 0 }).eq('id', user.id).select();
            }
            if ((updRes && updRes.error) || !updRes) {
              if (user.email) updRes = await sup.from('users').update({ hourly_rate: 0 }).eq('email', user.email).select();
            }
            if (updRes?.error) throw updRes.error;
            // Also set pay_type to 'flat' on the users row when possible
            try {
              if (user.auth_id) await sup.from('users').update({ pay_type: 'flat' }).eq('auth_id', user.auth_id).select();
              else if (user.id) await sup.from('users').update({ pay_type: 'flat' }).eq('id', user.id).select();
              else if (user.email) await sup.from('users').update({ pay_type: 'flat' }).eq('email', user.email).select();
            } catch (epp) { /* ignore */ }
            console.log('[PayType] Updated users.hourly_rate -> 0 and pay_type -> flat', updRes);
          } else {
            throw new Error('No identifier to persist pay type change');
          }

          showNotification('Pay type set to Flat Rate', 'success');
          closePayTypeModal();
          await renderTeam();
        } catch (ex) {
          console.error('Failed to update pay type:', ex);
          showNotification('Failed to update pay type', 'error');
        }
      });
      
      payTypeHourlyBtn?.addEventListener('click', async () => {
        const user = payTypeContext.user;
        console.log('[PayType] Hourly clicked, payTypeContext user:', user);
        if (!user) return;

        // For hourly, we need an hourly rate. If they don't have one, set a default
        const currentRate = user.hourly_rate ? Number(user.hourly_rate) : 0;
        const newRate = currentRate > 0 ? currentRate : 15; // Default to $15/hr if not set

        try {
          if (user.shop_staff_id) {
            const res = await sup.from('shop_staff').update({ hourly_rate: newRate, pay_type: 'hourly' }).eq('id', user.shop_staff_id).select();
            if (res?.error) throw res.error;
            console.log('[PayType] Updated shop_staff hourly_rate ->', newRate, 'and pay_type -> hourly', res);
          } else if (user.auth_id || user.id || user.email) {
            // Fallback to users table
            let updRes = null;
            if (user.auth_id) updRes = await sup.from('users').update({ hourly_rate: newRate }).eq('auth_id', user.auth_id).select();
            if ((updRes && updRes.error) || !updRes) {
              if (user.id) updRes = await sup.from('users').update({ hourly_rate: newRate }).eq('id', user.id).select();
            }
            if ((updRes && updRes.error) || !updRes) {
              if (user.email) updRes = await sup.from('users').update({ hourly_rate: newRate }).eq('email', user.email).select();
            }
            if (updRes?.error) throw updRes.error;
            // Also set pay_type to 'hourly' on the users row when possible
            try {
              if (user.auth_id) await sup.from('users').update({ pay_type: 'hourly' }).eq('auth_id', user.auth_id).select();
              else if (user.id) await sup.from('users').update({ pay_type: 'hourly' }).eq('id', user.id).select();
              else if (user.email) await sup.from('users').update({ pay_type: 'hourly' }).eq('email', user.email).select();
            } catch (epp) { /* ignore */ }
            console.log('[PayType] Updated users.hourly_rate ->', newRate, 'and pay_type -> hourly', updRes);
          } else {
            throw new Error('No identifier to persist pay type change');
          }

          showNotification(`Pay type set to Hourly (${newRate}/hr)`, 'success');
          closePayTypeModal();
          await renderTeam();
        } catch (ex) {
          console.error('Failed to update pay type:', ex);
          showNotification('Failed to update pay type', 'error');
        }
      });
      
      // Close modals on backdrop click
      staffManageModal?.addEventListener('click', (e) => {
        if (e.target === staffManageModal) closeStaffManageModal();
      });
      payTypeModal?.addEventListener('click', (e) => {
        if (e.target === payTypeModal) closePayTypeModal();
      });

      // In-page confirm helper (returns Promise<boolean>) using the page's confirm modal
      window.showConfirm = function showConfirm(message, okText = 'OK', cancelText = 'Cancel') {
        return new Promise((resolve) => {
          const modal = document.getElementById('confirmModal');
          const msgEl = document.getElementById('confirmMessage');
          const okBtn = document.getElementById('confirmOk');
          const cancelBtn = document.getElementById('confirmCancel');
          if (!modal || !msgEl || !okBtn || !cancelBtn) {
            // fallback to native confirm if modal not present
            resolve(window.confirm(message));
            return;
          }

          msgEl.textContent = message;
          okBtn.textContent = okText;
          cancelBtn.textContent = cancelText;

          function clean(result) {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', onOk);
            cancelBtn.removeEventListener('click', onCancel);
            resolve(result);
          }

          function onOk() { clean(true); }
          function onCancel() { clean(false); }

          okBtn.addEventListener('click', onOk);
          cancelBtn.addEventListener('click', onCancel);
          modal.classList.remove('hidden');
        });
      }

      // Wire regenerate button (update Supabase shops table)
      // This loop will attempt to update the shop with a brand new join code and will
      // retry if the DB reports a duplicate (unique constraint) to avoid ever producing
      // a duplicate join code due to race conditions.
      if(btnRegen && elJoin){
        btnRegen.addEventListener('click', async function(){
          const ok = await showConfirm('Generate a new join code for this shop?', 'Generate', 'Cancel');
          if (!ok) return;
          function gen(){ return Math.random().toString(36).slice(2,8).toUpperCase(); }

          const maxTries = 200; // generous cap to avoid infinite loops
          let tries = 0;
          let lastErr = null;

          while (tries < maxTries) {
            tries++;
            const code = gen();
            try {
              // Only update join_code to avoid touching non-existent columns like 'updated_at'
              const { data: updated, error: upErr } = await sup.from('shops')
                .update({ join_code: code })
                .eq('id', shop.id)
                .select()
                .single();

              if (upErr) {
                const msg = String(upErr?.message || upErr || '');
                if (upErr?.code === '23505' || /duplicate|unique/i.test(msg)) {
                  lastErr = upErr;
                  continue; // try another code
                }
                throw upErr;
              }

              // Success
              elJoin.value = updated.join_code || code;
              btnRegen.textContent = 'Saved'; setTimeout(()=> btnRegen.textContent = 'Regenerate Code', 1500);
              lastErr = null;
              break;
            } catch (ex) {
              const m = String(ex?.message || ex || '');
              if (/duplicate|unique|23505/i.test(m)) { lastErr = ex; continue; }
              console.warn('Failed to update join code', ex);
              // show in-page notification fallback
              alert('Could not update join code: ' + (ex.message || ex));
              return;
            }
          }

          if (tries >= maxTries) {
            console.error('Could not generate a unique join code after', maxTries, 'tries', lastErr);
            alert('Could not generate a unique join code. Please try again later.');
          }
        });
      }

    }catch(err){
      console.error('Error populating settings panel from Supabase', err);
    }

  })();

});
</script>

  <!-- Terminal registration component -->
  <script src="terminal-registration-component.js"></script>
  <script src="settings.js"></script>
  <script type="module">
  import { loadSubscriptionBanner } from './pages/settings-subscription.js';

  document.addEventListener('DOMContentLoaded', async () => {
  loadSubscriptionBanner();
  
  // Handle terminal purchase success
  const urlParams = new URLSearchParams(window.location.search);
  const terminalPurchase = urlParams.get('terminal_purchase');
  const sessionId = urlParams.get('session_id');
  
  if (terminalPurchase === 'success' && sessionId) {
    try {
      // Fetch session details to get terminal info
      const response = await fetch('https://xpose-stripe-server.vercel.app/api/terminal/purchase-complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId })
      });
      
      if (response.ok) {
        // Show success notification
        if (typeof showNotification === 'function') {
          showNotification('Terminal purchase successful! Your terminal will ship within 5-7 business days.', 'success');
        } else {
          alert('Terminal purchase successful! Your terminal will ship within 5-7 business days.');
        }
      }
      
      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    } catch (error) {
      console.error('Error completing terminal purchase:', error);
    }
  } else if (terminalPurchase === 'cancelled') {
    // Clean up URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
  
  // terminal-registration-component.js will auto-load the panel if #terminal-settings-section exists
});
  </script>

</body></html>